<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prompt Comparison Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            line-height: 1.5;
        }
        .textarea-container {
            position: relative;
        }
        .textarea-container textarea {
            resize: vertical;
            min-height: 180px;
            width: 100%;
            font-family: 'Fira Code', monospace;
            padding: 0.75rem;
            line-height: 1.5;
            border-radius: 0.375rem;
            border: 1px solid #e2e8f0;
            background-color: #f8fafc;
            color: #1e293b;
        }
        .textarea-container textarea:focus {
            outline: 2px solid #3b82f6;
            border-color: #3b82f6;
        }
        .textarea-container .char-count {
            position: absolute;
            bottom: 0.25rem;
            right: 0.5rem;
            font-size: 0.75rem;
            color: #64748b;
        }
        .parameter-row {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .parameter-row input {
            flex-grow: 1;
            padding: 0.5rem;
            border-radius: 0.375rem;
            border: 1px solid #e2e8f0;
            background-color: #f8fafc;
        }
        .parameter-row button {
            margin-left: 0.5rem;
        }
        .toast {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            background-color: #1e293b;
            color: white;
            font-size: 0.875rem;
            z-index: 50;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            opacity: 0;
            transform: translateY(1rem);
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .placeholder-highlight {
            background-color: #dbeafe;
            border-radius: 0.25rem;
            padding: 0.125rem 0.25rem;
            margin: 0 0.125rem;
            color: #1e40af;
            font-weight: 500;
        }
        .json-validation-error {
            color: #ef4444;
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }
        /* Dark mode styles */
        .dark {
            background-color: #1e293b;
            color: #f1f5f9;
        }
        .dark .textarea-container textarea {
            background-color: #0f172a;
            border-color: #334155;
            color: #f1f5f9;
        }
        .dark .parameter-row input {
            background-color: #0f172a;
            border-color: #334155;
            color: #f1f5f9;
        }
        .dark .card {
            background-color: #1e293b;
            border-color: #334155;
        }
        .dark .bg-white {
            background-color: #1e293b;
        }
        .dark .border-gray-200 {
            border-color: #334155;
        }
        .dark .text-gray-700 {
            color: #f1f5f9;
        }
        .dark .bg-gray-50 {
            background-color: #0f172a;
        }
        .dark .placeholder-highlight {
            background-color: #1e3a8a;
            color: #dbeafe;
        }
        /* Additional styles for the response display */
        .response-container {
            padding: 1rem;
            border-radius: 0.375rem;
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            margin-top: 1rem;
            white-space: pre-wrap;
            font-family: 'Fira Code', monospace;
            max-height: 400px;
            overflow-y: auto;
        }
        .dark .response-container {
            background-color: #0f172a;
            border-color: #334155;
        }
        
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }
        .dark .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .loading-indicator {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid rgba(59, 130, 246, 0.2);
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .btn-primary {
            background-color: #3b82f6;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        
        .btn-primary:hover {
            background-color: #2563eb;
        }
        
        .btn-secondary {
            background-color: #e2e8f0;
            color: #1e293b;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        
        .btn-secondary:hover {
            background-color: #cbd5e1;
        }
        
        .dark .btn-secondary {
            background-color: #334155;
            color: #f1f5f9;
        }
        
        .dark .btn-secondary:hover {
            background-color: #475569;
        }
        
        .btn-danger {
            background-color: #ef4444;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        
        .btn-danger:hover {
            background-color: #dc2626;
        }
        
        .btn-outline {
            background-color: transparent;
            border: 1px solid #3b82f6;
            color: #3b82f6;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: background-color 0.3s, color 0.3s;
        }
        
        .btn-outline:hover {
            background-color: #3b82f6;
            color: white;
        }
        
        .dark .btn-outline {
            border-color: #3b82f6;
            color: #3b82f6;
        }
        
        .dark .btn-outline:hover {
            background-color: #3b82f6;
            color: #f1f5f9;
        }
        
        /* Specific styles for the placeholder format */
        .placeholder-format {
            display: inline-block;
            background-color: #f1f5f9;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-family: monospace;
            margin: 0 0.25rem;
        }
        
        .dark .placeholder-format {
            background-color: #334155;
        }
        
        /* Styles for delete buttons */
        .delete-btn {
            color: #ef4444;
            border: 1px solid #ef4444;
            background-color: transparent;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .delete-btn:hover {
            background-color: #ef4444;
            color: white;
        }
        
        .select-with-actions {
            display: flex;
            align-items: center;
        }
        
        .select-with-actions select {
            flex: 1;
            margin-right: 0.5rem;
        }
        
        /* Confirm delete modal */
        .confirm-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .confirm-modal-content {
            background-color: white;
            border-radius: 0.5rem;
            padding: 1.5rem;
            width: 90%;
            max-width: 450px;
        }
        
        .dark .confirm-modal-content {
            background-color: #1e293b;
            color: #f1f5f9;
        }
        
        /* Model selection styles */
        .model-selection {
            margin-bottom: 1rem;
            padding: 0.5rem;
            border-radius: 0.375rem;
            border: 1px dashed #cbd5e1;
            background-color: #f8fafc;
        }
        
        .dark .model-selection {
            background-color: #0f172a;
            border-color: #334155;
        }
        
        .model-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
            margin-left: 0.5rem;
            background-color: #3b82f6;
            color: white;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50 text-gray-800">
    <div id="app" class="container mx-auto py-6 px-4">
        <!-- Header -->
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-blue-600">Prompt Comparison Tool</h1>
            <div class="flex items-center space-x-2">
                <button id="apiConfigBtn" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700">
                    <i class="fas fa-cog"></i>
                </button>
                <button id="darkModeToggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700">
                    <i class="fas fa-moon dark:hidden"></i>
                    <i class="fas fa-sun hidden dark:block"></i>
                </button>
            </div>
        </header>

        <!-- Navigation and Configuration -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <!-- Category and Prompt Management -->
            <div class="md:col-span-4 flex flex-col space-y-2">
                <div class="flex items-center space-x-2 mb-2">
                    <label class="font-medium text-gray-700 dark:text-gray-300">Category:</label>
                    <div class="flex-grow flex items-center space-x-2">
                        <select id="categorySelect" class="flex-grow p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200">
                            <option value="">Select Category</option>
                        </select>
                        <button id="deleteCategoryBtn" class="delete-btn">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                        <button id="newCategoryBtn" class="btn-outline flex items-center">
                            <i class="fas fa-plus mr-1"></i> New
                        </button>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <label class="font-medium text-gray-700 dark:text-gray-300">Prompt:</label>
                    <div class="flex-grow flex items-center space-x-2">
                        <select id="promptSelect" class="flex-grow p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200">
                            <option value="">Select Prompt</option>
                        </select>
                        <button id="deletePromptBtn" class="delete-btn">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                        <button id="newPromptBtn" class="btn-outline flex items-center">
                            <i class="fas fa-plus mr-1"></i> New
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mode Tabs -->
        <div class="flex border-b border-gray-200 dark:border-gray-700 mb-6">
            <button id="editModeBtn" class="px-4 py-2 border-b-2 border-blue-500 font-medium text-blue-500">
                Edit Mode
            </button>
            <button id="compareModeBtn" class="px-4 py-2 border-b-2 border-transparent font-medium text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
                Compare Mode
            </button>
        </div>

        <!-- Edit Mode Content -->
        <div id="editModeContent">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-200">Development Version</h2>
                    <div class="flex space-x-2">
                        <button id="saveAsStableBtn" class="btn-primary">
                            Save as Stable
                        </button>
                        <button id="testBtn" class="btn-secondary">
                            Test
                        </button>
                    </div>
                </div>

                <!-- Model Selection for Dev Version -->
                <div class="model-selection mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Model for Testing:</label>
                    <select id="devModelSelect" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200">
                        <!-- Models will be added here -->
                    </select>
                </div>

                <!-- Prompts -->
                <div class="space-y-4">
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">System Prompt</label>
                            <div class="text-xs text-gray-500 dark:text-gray-400">
                                Use <span class="placeholder-format">${variable}</span> for placeholders
                            </div>
                        </div>
                        <div class="textarea-container">
                            <textarea id="systemPrompt" class="custom-scrollbar" placeholder="Enter your system prompt here..."></textarea>
                            <div class="char-count">0 characters</div>
                        </div>
                    </div>
                    
                    <div>
                        <div class="flex items-center justify-between mb-2">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">User Prompt</label>
                            <div class="text-xs text-gray-500 dark:text-gray-400">
                                Use <span class="placeholder-format">${variable}</span> for placeholders
                            </div>
                        </div>
                        <div class="textarea-container">
                            <textarea id="userPrompt" class="custom-scrollbar" placeholder="Enter your user prompt here..."></textarea>
                            <div class="char-count">0 characters</div>
                        </div>
                    </div>
                </div>
                
                <!-- Parameters -->
                <div class="mt-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300">Model Parameters</h3>
                        <button id="addParameterBtn" class="btn-outline flex items-center text-sm">
                            <i class="fas fa-plus mr-1"></i> Add Parameter
                        </button>
                    </div>
                    <div id="parametersContainer" class="space-y-2">
                        <!-- Parameters will be added here -->
                        <div class="parameter-row">
                            <input type="text" value="temperature" class="parameter-key" readonly>
                            <input type="text" value="0.7" class="parameter-value">
                            <button class="remove-parameter text-red-500 hover:text-red-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="parameter-row">
                            <input type="text" value="top_p" class="parameter-key" readonly>
                            <input type="text" value="1" class="parameter-value">
                            <button class="remove-parameter text-red-500 hover:text-red-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Test Input Section -->
                <div id="testInputSection" class="mt-6">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300">Test Input</h3>
                        <div id="placeholderStatus" class="text-xs text-gray-500 dark:text-gray-400">
                            No placeholders detected
                        </div>
                    </div>
                    <div class="textarea-container">
                        <textarea id="testInput" class="custom-scrollbar" placeholder='Enter JSON for placeholders: { "variable": "value" }'></textarea>
                        <div class="json-validation-error hidden" id="jsonValidationError">Invalid JSON format</div>
                    </div>
                </div>

                <!-- Response Section -->
                <div id="responseSection" class="mt-6 hidden">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300">Response</h3>
                        <div class="model-badge" id="responseModelBadge">model-name</div>
                    </div>
                    <div class="flex items-center space-x-2 text-sm text-gray-500 dark:text-gray-400 mb-2">
                        <div id="responseStats"></div>
                        <button id="copyResponseBtn" class="text-blue-500 hover:text-blue-700">
                            <i class="fas fa-copy mr-1"></i> Copy
                        </button>
                    </div>
                    <div id="responseContainer" class="response-container custom-scrollbar"></div>
                </div>
            </div>
        </div>

        <!-- Compare Mode Content -->
        <div id="compareModeContent" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Development Version -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-200">Development Version</h2>
                        <div class="model-selection">
                            <select id="compareDevModelSelect" class="p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200">
                                <!-- Models will be added here -->
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300">System Prompt</h3>
                        <div id="compareDevSystemPrompt" class="mt-2 p-3 bg-gray-50 dark:bg-gray-900 rounded border border-gray-200 dark:border-gray-700 custom-scrollbar" style="white-space: pre-wrap; min-height: 100px; max-height: 200px; overflow-y: auto;"></div>
                    </div>
                    
                    <div class="mb-4">
                        <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300">User Prompt</h3>
                        <div id="compareDevUserPrompt" class="mt-2 p-3 bg-gray-50 dark:bg-gray-900 rounded border border-gray-200 dark:border-gray-700 custom-scrollbar" style="white-space: pre-wrap; min-height: 100px; max-height: 200px; overflow-y: auto;"></div>
                    </div>
                    
                    <div class="mb-4">
                        <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300">Parameters</h3>
                        <div id="compareDevParams" class="mt-2 p-3 bg-gray-50 dark:bg-gray-900 rounded border border-gray-200 dark:border-gray-700"></div>
                    </div>
                    
                    <div id="compareDevResponseSection" class="hidden">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300">Response</h3>
                            <div class="model-badge" id="compareDevModelBadge">model-name</div>
                        </div>
                        <div class="flex items-center space-x-2 text-sm text-gray-500 dark:text-gray-400 mb-2">
                            <div id="compareDevResponseStats"></div>
                        </div>
                        <div id="compareDevResponseContainer" class="response-container custom-scrollbar"></div>
                    </div>
                </div>
                
                <!-- Stable Version -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-200">Stable Version</h2>
                        <div class="flex items-center">
                            <select id="stableVersionSelect" class="p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 mr-2">
                                <option value="">Select Stable Version</option>
                            </select>
                            <button id="deleteStableVersionBtn" class="delete-btn">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="model-selection mb-4">
                        <select id="compareStableModelSelect" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200">
                            <!-- Models will be added here -->
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300">System Prompt</h3>
                        <div id="compareStableSystemPrompt" class="mt-2 p-3 bg-gray-50 dark:bg-gray-900 rounded border border-gray-200 dark:border-gray-700 custom-scrollbar" style="white-space: pre-wrap; min-height: 100px; max-height: 200px; overflow-y: auto;"></div>
                    </div>
                    
                    <div class="mb-4">
                        <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300">User Prompt</h3>
                        <div id="compareStableUserPrompt" class="mt-2 p-3 bg-gray-50 dark:bg-gray-900 rounded border border-gray-200 dark:border-gray-700 custom-scrollbar" style="white-space: pre-wrap; min-height: 100px; max-height: 200px; overflow-y: auto;"></div>
                    </div>
                    
                    <div class="mb-4">
                        <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300">Parameters</h3>
                        <div id="compareStableParams" class="mt-2 p-3 bg-gray-50 dark:bg-gray-900 rounded border border-gray-200 dark:border-gray-700"></div>
                    </div>
                    
                    <div id="compareStableResponseSection" class="hidden">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300">Response</h3>
                            <div class="model-badge" id="compareStableModelBadge">model-name</div>
                        </div>
                        <div class="flex items-center space-x-2 text-sm text-gray-500 dark:text-gray-400 mb-2">
                            <div id="compareStableResponseStats"></div>
                        </div>
                        <div id="compareStableResponseContainer" class="response-container custom-scrollbar"></div>
                    </div>
                </div>
            </div>
            
            <!-- Compare Controls -->
            <div class="flex justify-center mt-6 space-x-4">
                <div id="compareTestInputContainer" class="w-full max-w-2xl">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-lg font-medium text-gray-700 dark:text-gray-300">Test Input</h3>
                        <div id="comparePlaceholderStatus" class="text-xs text-gray-500 dark:text-gray-400">
                            Checking for placeholders...
                        </div>
                    </div>
                    <div class="textarea-container mb-4">
                        <textarea id="compareTestInput" class="custom-scrollbar" placeholder='Enter JSON for placeholders: { "variable": "value" }'></textarea>
                        <div class="json-validation-error hidden" id="compareJsonValidationError">Invalid JSON format</div>
                    </div>
                    <div class="flex justify-center">
                        <button id="runComparisonBtn" class="btn-primary">
                            Compare Responses
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- New Category Modal -->
        <div id="newCategoryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-md">
                <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-4">Create New Category</h3>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Category Name</label>
                    <input id="newCategoryName" type="text" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200" placeholder="Enter category name...">
                </div>
                <div class="flex justify-end space-x-2">
                    <button id="cancelNewCategoryBtn" class="btn-secondary">Cancel</button>
                    <button id="saveNewCategoryBtn" class="btn-primary">Create</button>
                </div>
            </div>
        </div>
        
        <!-- New Prompt Modal -->
        <div id="newPromptModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-md">
                <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-4">Create New Prompt</h3>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Prompt Name</label>
                    <input id="newPromptName" type="text" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200" placeholder="Enter prompt name...">
                </div>
                <div class="flex justify-end space-x-2">
                    <button id="cancelNewPromptBtn" class="btn-secondary">Cancel</button>
                    <button id="saveNewPromptBtn" class="btn-primary">Create</button>
                </div>
            </div>
        </div>
        
        <!-- Save Version Modal -->
        <div id="saveVersionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-md">
                <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-4">Save Stable Version</h3>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Version Name</label>
                    <input id="versionName" type="text" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200" placeholder="Enter version name...">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Description (optional)</label>
                    <textarea id="versionDescription" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 custom-scrollbar" placeholder="Enter version description..."></textarea>
                </div>
                <div class="flex justify-end space-x-2">
                    <button id="cancelSaveVersionBtn" class="btn-secondary">Cancel</button>
                    <button id="confirmSaveVersionBtn" class="btn-primary">Save</button>
                </div>
            </div>
        </div>
        
        <!-- Add Parameter Modal -->
        <div id="addParameterModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-md">
                <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-4">Add Parameter</h3>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Parameter Name</label>
                    <input id="newParameterName" type="text" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200" placeholder="e.g., max_tokens, frequency_penalty">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Parameter Value</label>
                    <input id="newParameterValue" type="text" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200" placeholder="e.g., 2048, 0.5">
                </div>
                <div class="flex justify-end space-x-2">
                    <button id="cancelAddParameterBtn" class="btn-secondary">Cancel</button>
                    <button id="confirmAddParameterBtn" class="btn-primary">Add</button>
                </div>
            </div>
        </div>
        
        <!-- Add Model Modal -->
        <div id="addModelModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-md">
                <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-4">Add Model</h3>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Model Name</label>
                    <input id="newModelName" type="text" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200" placeholder="e.g., gpt-4, gpt-3.5-turbo">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Display Name (optional)</label>
                    <input id="newModelDisplayName" type="text" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200" placeholder="e.g., GPT-4, GPT-3.5">
                </div>
                <div class="flex justify-end space-x-2">
                    <button id="cancelAddModelBtn" class="btn-secondary">Cancel</button>
                    <button id="confirmAddModelBtn" class="btn-primary">Add</button>
                </div>
            </div>
        </div>
        
        <!-- Confirm Delete Modal with highest priority -->
        <div id="confirmDeleteModal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.75); align-items: center; justify-content: center; z-index: 9999;">
            <div style="background-color: white; border-radius: 8px; padding: 24px; width: 100%; max-width: 400px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 16px; color: #1f2937;">确认删除</h3>
                <p id="confirmDeleteMessage" style="margin-bottom: 24px; color: #4b5563;">确定要删除此项目吗？</p>
                <div style="display: flex; justify-content: flex-end; gap: 8px;">
                    <button id="cancelDeleteBtn" style="padding: 8px 16px; border-radius: 4px; background-color: #e5e7eb; color: #1f2937; border: none; cursor: pointer;">取消</button>
                    <button id="confirmDeleteBtn" style="padding: 8px 16px; border-radius: 4px; background-color: #ef4444; color: white; border: none; cursor: pointer;">删除</button>
                </div>
            </div>
        </div>
        
        <!-- Toast -->
        <div id="toast" class="toast"></div>

        <!-- Add new API Config Modal -->
        <div id="apiConfigModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200">API 配置</h3>
                    <button id="closeApiConfigBtn" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <!-- API Configurations Section -->
                <div class="mb-6">
                    <h4 class="text-lg font-medium text-gray-700 dark:text-gray-300 mb-3">API配置列表</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="apiConfigsContainer">
                        <!-- API configurations will be displayed here -->
                    </div>
                </div>
                
                <!-- Add New API Config Section -->
                <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mb-4">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-lg font-medium text-gray-700 dark:text-gray-300">添加新配置</h4>
                        <button id="addApiConfigBtn" class="btn-outline flex items-center text-sm">
                            <i class="fas fa-plus mr-1"></i> 添加新配置
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Add New API Config Modal -->
        <div id="newApiConfigModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-md">
                <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-4">添加新API配置</h3>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">配置名称</label>
                    <input id="newApiConfigName" type="text" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200" placeholder="例如: OpenAI API, Azure API">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Base URL</label>
                    <input id="newApiConfigBaseUrl" type="text" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200" placeholder="例如: https://api.openai.com/v1">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">API Key</label>
                    <input id="newApiConfigApiKey" type="password" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200" placeholder="API Key">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">可用模型</label>
                    <div class="mb-2">
                        <div class="flex items-center space-x-2">
                            <input id="newModelInput" type="text" class="flex-grow p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200" placeholder="输入模型名称，如 gpt-3.5-turbo">
                            <button id="addModelToConfigBtn" class="btn-outline">添加</button>
                        </div>
                    </div>
                    <div id="newApiConfigModelsContainer" class="border border-gray-300 dark:border-gray-600 rounded-md p-2 max-h-40 overflow-y-auto">
                        <!-- Models will be added here -->
                    </div>
                </div>
                <div class="flex justify-end space-x-2">
                    <button id="cancelNewApiConfigBtn" class="btn-secondary">取消</button>
                    <button id="saveNewApiConfigBtn" class="btn-primary">添加</button>
                </div>
            </div>
        </div>

        <div id="editApiConfigModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100] hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg p-6 w-full max-w-md">
                <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-4">编辑API配置</h3>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">配置名称</label>
                    <input id="editApiConfigName" type="text" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200" placeholder="例如: OpenAI API, Azure API">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Base URL</label>
                    <input id="editApiConfigBaseUrl" type="text" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200" placeholder="例如: https://api.openai.com/v1">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">API Key</label>
                    <input id="editApiConfigApiKey" type="password" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200" placeholder="API Key">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">可用模型</label>
                    <div class="mb-2">
                        <div class="flex items-center space-x-2">
                            <input id="editModelInput" type="text" class="flex-grow p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200" placeholder="输入模型名称，如 gpt-3.5-turbo">
                            <button id="addModelToEditBtn" class="btn-outline">添加</button>
                            <button id="refreshModelsBtn" class="btn-outline p-2 ml-1" title="自动获取模型列表">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div id="editApiConfigModelsContainer" class="border border-gray-300 dark:border-gray-600 rounded-md p-2 max-h-40 overflow-y-auto">
                        <!-- Models will be added here -->
                    </div>
                </div>
                <input type="hidden" id="editApiConfigId">
                <div class="flex justify-end space-x-2">
                    <button id="cancelEditApiConfigBtn" class="btn-secondary">取消</button>
                    <button id="saveEditApiConfigBtn" class="btn-primary">保存</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM fully loaded, setting up initial event listeners');
            
            // 确保确认删除模态框在初始状态下是隐藏的
            const confirmDeleteModal = document.getElementById('confirmDeleteModal');
            if (confirmDeleteModal) {
                confirmDeleteModal.style.display = 'none';
                confirmDeleteModal.classList.add('hidden');
            }
            
            // 首先设置API Config按钮的点击事件，确保它最先被设置
            const apiConfigBtn = document.getElementById('apiConfigBtn');
            if (apiConfigBtn) {
                console.log('API Config button found, setting up click event');
                apiConfigBtn.addEventListener('click', function() {
                    console.log('API Config button clicked');
                    const modal = document.getElementById('apiConfigModal');
                    if (modal) {
                        modal.classList.remove('hidden');
                        console.log('API Config modal displayed');
                    } else {
                        console.error('API Config modal not found');
                    }
                });
            } else {
                console.error('API Config button not found!');
            }

            // State management
            const state = {
                models: [],
                tempModels: [],
                editTempModels: [], // 添加编辑时的临时模型数组
                apiConfigs: [],
                categories: [], // 初始化categories为空数组
                prompts: {}, // 初始化prompts为空对象
                currentCategory: null,
                currentPrompt: null,
                selectedSourceCategory: null,
                selectedTargetCategory: null,
                promptCategoryItems: {}
            };

            // DOM elements
            const elements = {
                // Dark mode
                darkModeToggle: document.getElementById('darkModeToggle'),
                
                // API Config Button
                apiConfigBtn: document.getElementById('apiConfigBtn'),
                apiConfigModal: document.getElementById('apiConfigModal'),
                closeApiConfigBtn: document.getElementById('closeApiConfigBtn'),
                apiConfigsContainer: document.getElementById('apiConfigsContainer'),
                
                // New API Config
                addApiConfigBtn: document.getElementById('addApiConfigBtn'),
                newApiConfigModal: document.getElementById('newApiConfigModal'),
                newApiConfigName: document.getElementById('newApiConfigName'),
                newApiConfigBaseUrl: document.getElementById('newApiConfigBaseUrl'),
                newApiConfigApiKey: document.getElementById('newApiConfigApiKey'),
                newModelInput: document.getElementById('newModelInput'),
                addModelToConfigBtn: document.getElementById('addModelToConfigBtn'),
                newApiConfigModelsContainer: document.getElementById('newApiConfigModelsContainer'),
                cancelNewApiConfigBtn: document.getElementById('cancelNewApiConfigBtn'),
                saveNewApiConfigBtn: document.getElementById('saveNewApiConfigBtn'),
                
                // Category and prompt selection
                categorySelect: document.getElementById('categorySelect'),
                promptSelect: document.getElementById('promptSelect'),
                newCategoryBtn: document.getElementById('newCategoryBtn'),
                newPromptBtn: document.getElementById('newPromptBtn'),
                deleteCategoryBtn: document.getElementById('deleteCategoryBtn'),
                deletePromptBtn: document.getElementById('deletePromptBtn'),
                
                // Model Management
                availableModelsContainer: document.getElementById('availableModelsContainer'),
                addModelBtn: document.getElementById('addModelBtn'),
                
                // Model selection for different modes
                devModelSelect: document.getElementById('devModelSelect'),
                compareDevModelSelect: document.getElementById('compareDevModelSelect'),
                compareStableModelSelect: document.getElementById('compareStableModelSelect'),
                
                // Model badges for responses
                responseModelBadge: document.getElementById('responseModelBadge'),
                compareDevModelBadge: document.getElementById('compareDevModelBadge'),
                compareStableModelBadge: document.getElementById('compareStableModelBadge'),
                
                // Mode switching
                editModeBtn: document.getElementById('editModeBtn'),
                compareModeBtn: document.getElementById('compareModeBtn'),
                editModeContent: document.getElementById('editModeContent'),
                compareModeContent: document.getElementById('compareModeContent'),
                
                // Development version
                systemPrompt: document.getElementById('systemPrompt'),
                userPrompt: document.getElementById('userPrompt'),
                saveAsStableBtn: document.getElementById('saveAsStableBtn'),
                testBtn: document.getElementById('testBtn'),
                
                // Parameters
                parametersContainer: document.getElementById('parametersContainer'),
                addParameterBtn: document.getElementById('addParameterBtn'),
                
                // Test input
                testInputSection: document.getElementById('testInputSection'),
                placeholderStatus: document.getElementById('placeholderStatus'),
                testInput: document.getElementById('testInput'),
                jsonValidationError: document.getElementById('jsonValidationError'),
                
                // Response
                responseSection: document.getElementById('responseSection'),
                responseStats: document.getElementById('responseStats'),
                responseContainer: document.getElementById('responseContainer'),
                copyResponseBtn: document.getElementById('copyResponseBtn'),
                
                // Comparison mode
                stableVersionSelect: document.getElementById('stableVersionSelect'),
                deleteStableVersionBtn: document.getElementById('deleteStableVersionBtn'),
                compareDevSystemPrompt: document.getElementById('compareDevSystemPrompt'),
                compareDevUserPrompt: document.getElementById('compareDevUserPrompt'),
                compareDevParams: document.getElementById('compareDevParams'),
                compareDevResponseSection: document.getElementById('compareDevResponseSection'),
                compareDevResponseStats: document.getElementById('compareDevResponseStats'),
                compareDevResponseContainer: document.getElementById('compareDevResponseContainer'),
                
                compareStableSystemPrompt: document.getElementById('compareStableSystemPrompt'),
                compareStableUserPrompt: document.getElementById('compareStableUserPrompt'),
                compareStableParams: document.getElementById('compareStableParams'),
                compareStableResponseSection: document.getElementById('compareStableResponseSection'),
                compareStableResponseStats: document.getElementById('compareStableResponseStats'),
                compareStableResponseContainer: document.getElementById('compareStableResponseContainer'),
                
                compareTestInputContainer: document.getElementById('compareTestInputContainer'),
                comparePlaceholderStatus: document.getElementById('comparePlaceholderStatus'),
                compareTestInput: document.getElementById('compareTestInput'),
                compareJsonValidationError: document.getElementById('compareJsonValidationError'),
                runComparisonBtn: document.getElementById('runComparisonBtn'),
                
                // Modals
                newCategoryModal: document.getElementById('newCategoryModal'),
                newCategoryName: document.getElementById('newCategoryName'),
                cancelNewCategoryBtn: document.getElementById('cancelNewCategoryBtn'),
                saveNewCategoryBtn: document.getElementById('saveNewCategoryBtn'),
                
                newPromptModal: document.getElementById('newPromptModal'),
                newPromptName: document.getElementById('newPromptName'),
                cancelNewPromptBtn: document.getElementById('cancelNewPromptBtn'),
                saveNewPromptBtn: document.getElementById('saveNewPromptBtn'),
                
                saveVersionModal: document.getElementById('saveVersionModal'),
                versionName: document.getElementById('versionName'),
                versionDescription: document.getElementById('versionDescription'),
                cancelSaveVersionBtn: document.getElementById('cancelSaveVersionBtn'),
                confirmSaveVersionBtn: document.getElementById('confirmSaveVersionBtn'),
                
                addParameterModal: document.getElementById('addParameterModal'),
                newParameterName: document.getElementById('newParameterName'),
                newParameterValue: document.getElementById('newParameterValue'),
                cancelAddParameterBtn: document.getElementById('cancelAddParameterBtn'),
                confirmAddParameterBtn: document.getElementById('confirmAddParameterBtn'),
                
                addModelModal: document.getElementById('addModelModal'),
                newModelName: document.getElementById('newModelName'),
                newModelDisplayName: document.getElementById('newModelDisplayName'),
                cancelAddModelBtn: document.getElementById('cancelAddModelBtn'),
                confirmAddModelBtn: document.getElementById('confirmAddModelBtn'),
                
                // Confirm Delete Modal
                confirmDeleteModal: document.getElementById('confirmDeleteModal'),
                confirmDeleteMessage: document.getElementById('confirmDeleteMessage'),
                cancelDeleteBtn: document.getElementById('cancelDeleteBtn'),
                confirmDeleteBtn: document.getElementById('confirmDeleteBtn'),
                
                // Toast
                toast: document.getElementById('toast')
            };

            // Initialize the app
            init();

            function init() {
                // Load data from localStorage
                loadState();
                
                // 如果没有任何API配置，添加一个空白的供用户配置
                if (state.apiConfigs.length === 0) {
                    console.log('No API configs found, will prompt user to create one');
                }
                
                // Initialize UI
                updateCategorySelect();
                updatePromptSelect();
                updateStableVersionSelect();
                try {
                    updateApiConfigsDisplay();
                    updateModelSelects(); // 恢复对模型选择器更新的调用
                } catch (error) {
                    console.error('Error updating UI:', error);
                }
                setDarkMode(state.darkMode);
                
                // Set up event listeners
                setupEventListeners();
                
                // Check for placeholders in initial prompts
                updatePlaceholderStatus();
                
                // Set default models if not already set
                if (!state.currentDevModel && state.models.length > 0) {
                    state.currentDevModel = state.models[0].id;
                }
                if (!state.currentCompareDevModel && state.models.length > 0) {
                    state.currentCompareDevModel = state.models[0].id;
                }
                if (!state.currentCompareStableModel && state.models.length > 0) {
                    state.currentCompareStableModel = state.models[0].id;
                }
            }

            function loadState() {
                try {
                    // Load categories
                    const savedCategories = localStorage.getItem('promptCategories');
                    if (savedCategories) {
                        state.categories = JSON.parse(savedCategories);
                    }
                    
                    // Load prompts
                    const savedPrompts = localStorage.getItem('promptData');
                    if (savedPrompts) {
                        state.prompts = JSON.parse(savedPrompts);
                    }
                    
                    // Load API configs
                    const savedApiConfigs = localStorage.getItem('apiConfigs');
                    if (savedApiConfigs) {
                        const encryptedConfigs = JSON.parse(savedApiConfigs);
                        // 解密所有API密钥
                        state.apiConfigs = encryptedConfigs.map(config => {
                            return {
                                ...config,
                                apiKey: decryptApiKey(config.apiKey)
                            };
                        });
                    }
                    
                    // Load models
                    const savedModels = localStorage.getItem('availableModels');
                    if (savedModels) {
                        // 兼容旧版数据，但不再使用全局模型
                    }
                } catch (error) {
                    console.error('Error loading data from localStorage:', error);
                    showToast('Error loading saved data. Starting fresh.', 'error');
                }
            }

            // 简单加密函数 - 使用简单的XOR加密
            function encryptApiKey(apiKey) {
                // 使用固定的密钥，这只是基本保护，不是真正的安全加密
                const secretKey = "prompt_comparison_app_secret_key";
                let encrypted = "";
                
                for(let i = 0; i < apiKey.length; i++) {
                    // 对每个字符进行XOR操作
                    const charCode = apiKey.charCodeAt(i) ^ secretKey.charCodeAt(i % secretKey.length);
                    encrypted += String.fromCharCode(charCode);
                }
                
                // 转换为Base64以便安全存储
                return btoa(encrypted);
            }
            
            // 简单解密函数
            function decryptApiKey(encryptedKey) {
                if (!encryptedKey) return "";
                
                const secretKey = "prompt_comparison_app_secret_key";
                let decrypted = "";
                
                try {
                    // 从Base64解码
                    const encrypted = atob(encryptedKey);
                    
                    for(let i = 0; i < encrypted.length; i++) {
                        // 再次XOR得到原始字符
                        const charCode = encrypted.charCodeAt(i) ^ secretKey.charCodeAt(i % secretKey.length);
                        decrypted += String.fromCharCode(charCode);
                    }
                    
                    return decrypted;
                } catch (e) {
                    console.error("解密失败:", e);
                    return "";
                }
            }

            function saveState() {
                try {
                    // 在保存API配置前加密所有API密钥
                    const encryptedApiConfigs = state.apiConfigs.map(config => {
                        // 创建新对象以避免修改原始state
                        return {
                            ...config,
                            apiKey: encryptApiKey(config.apiKey)
                        };
                    });
                    
                    localStorage.setItem('promptCategories', JSON.stringify(state.categories));
                    localStorage.setItem('promptData', JSON.stringify(state.prompts));
                    localStorage.setItem('apiConfigs', JSON.stringify(encryptedApiConfigs));
                    localStorage.setItem('darkMode', state.darkMode);
                } catch (error) {
                    console.error('Error saving data to localStorage:', error);
                    showToast('Error saving data', 'error');
                }
            }

            function setupEventListeners() {
                // Dark mode toggle
                if (elements.darkModeToggle) {
                    elements.darkModeToggle.addEventListener('click', toggleDarkMode);
                }
                
                // 直接使用DOM获取元素并绑定事件，避免缓存的elements引用可能不存在
                const apiConfigBtn = document.getElementById('apiConfigBtn');
                if (apiConfigBtn) {
                    console.log('API config button found, attaching click event');
                    apiConfigBtn.addEventListener('click', function() {
                        console.log('API config button clicked');
                        const apiConfigModal = document.getElementById('apiConfigModal');
                        if (apiConfigModal) {
                            apiConfigModal.classList.remove('hidden');
                            console.log('API config modal displayed');
                        } else {
                            console.error('API config modal not found');
                        }
                    });
                }
                
                // 绑定其他新配置相关按钮
                bindNewApiConfigButtons();
                
                try {
                    // Category and prompt selection
                    if (elements.categorySelect) {
                        elements.categorySelect.addEventListener('change', onCategoryChange);
                    }
                    if (elements.promptSelect) {
                        elements.promptSelect.addEventListener('change', onPromptChange);
                    }
                    if (elements.newCategoryBtn) {
                        elements.newCategoryBtn.addEventListener('click', showNewCategoryModal);
                    }
                    if (elements.newPromptBtn) {
                        elements.newPromptBtn.addEventListener('click', showNewPromptModal);
                    }
                    if (elements.deleteCategoryBtn) {
                        elements.deleteCategoryBtn.addEventListener('click', showDeleteCategoryConfirm);
                    }
                    if (elements.deletePromptBtn) {
                        elements.deletePromptBtn.addEventListener('click', showDeletePromptConfirm);
                    }
                    if (elements.deleteStableVersionBtn) {
                        elements.deleteStableVersionBtn.addEventListener('click', showDeleteStableVersionConfirm);
                    }
                    
                    // Model selection
                    if (elements.devModelSelect) {
                        elements.devModelSelect.addEventListener('change', (e) => {
                            // 模型值现在包含配置ID和模型ID
                            saveState();
                        });
                    }
                    
                    if (elements.compareDevModelSelect) {
                        elements.compareDevModelSelect.addEventListener('change', (e) => {
                            // 模型值现在包含配置ID和模型ID
                            saveState();
                        });
                    }
                    
                    if (elements.compareStableModelSelect) {
                        elements.compareStableModelSelect.addEventListener('change', (e) => {
                            // 模型值现在包含配置ID和模型ID
                            saveState();
                        });
                    }
                    
                    // Model management
                    if (elements.addModelBtn) {
                        elements.addModelBtn.addEventListener('click', showAddModelModal);
                    }
                    
                    // Mode switching
                    if (elements.editModeBtn) {
                        elements.editModeBtn.addEventListener('click', () => switchMode(false));
                    }
                    if (elements.compareModeBtn) {
                        elements.compareModeBtn.addEventListener('click', () => switchMode(true));
                    }
                    
                    // Development version
                    if (elements.systemPrompt) {
                        elements.systemPrompt.addEventListener('input', (e) => {
                            updateCharCount(e.target);
                            saveDevelopmentVersion();
                            updatePlaceholderStatus();
                        });
                    }
                    if (elements.userPrompt) {
                        elements.userPrompt.addEventListener('input', (e) => {
                            updateCharCount(e.target);
                            saveDevelopmentVersion();
                            updatePlaceholderStatus();
                        });
                    }
                    if (elements.saveAsStableBtn) {
                        elements.saveAsStableBtn.addEventListener('click', showSaveVersionModal);
                    }
                    if (elements.testBtn) {
                        elements.testBtn.addEventListener('click', testPrompt);
                    }
                    
                    // Parameters
                    if (elements.addParameterBtn) {
                        elements.addParameterBtn.addEventListener('click', showAddParameterModal);
                    }
                    document.querySelectorAll('.remove-parameter').forEach(btn => {
                        btn.addEventListener('click', removeParameter);
                    });
                    
                    // Test input
                    if (elements.testInput) {
                        elements.testInput.addEventListener('input', validateJsonInput);
                    }
                    
                    // Response
                    if (elements.copyResponseBtn) {
                        elements.copyResponseBtn.addEventListener('click', copyResponse);
                    }
                    
                    // Comparison mode
                    if (elements.stableVersionSelect) {
                        elements.stableVersionSelect.addEventListener('change', updateComparisonView);
                    }
                    if (elements.compareTestInput) {
                        elements.compareTestInput.addEventListener('input', () => validateJsonInput(null, true));
                    }
                    if (elements.runComparisonBtn) {
                        elements.runComparisonBtn.addEventListener('click', runComparison);
                    }
                    
                    // Modals
                    if (elements.cancelNewCategoryBtn) {
                        elements.cancelNewCategoryBtn.addEventListener('click', hideNewCategoryModal);
                    }
                    if (elements.saveNewCategoryBtn) {
                        elements.saveNewCategoryBtn.addEventListener('click', createNewCategory);
                    }
                    
                    if (elements.cancelNewPromptBtn) {
                        elements.cancelNewPromptBtn.addEventListener('click', hideNewPromptModal);
                    }
                    if (elements.saveNewPromptBtn) {
                        elements.saveNewPromptBtn.addEventListener('click', createNewPrompt);
                    }
                    
                    if (elements.cancelSaveVersionBtn) {
                        elements.cancelSaveVersionBtn.addEventListener('click', hideSaveVersionModal);
                    }
                    if (elements.confirmSaveVersionBtn) {
                        elements.confirmSaveVersionBtn.addEventListener('click', saveStableVersion);
                    }
                    
                    if (elements.cancelAddParameterBtn) {
                        elements.cancelAddParameterBtn.addEventListener('click', hideAddParameterModal);
                    }
                    if (elements.confirmAddParameterBtn) {
                        elements.confirmAddParameterBtn.addEventListener('click', addParameter);
                    }
                    
                    if (elements.cancelAddModelBtn) {
                        elements.cancelAddModelBtn.addEventListener('click', hideAddModelModal);
                    }
                    if (elements.confirmAddModelBtn) {
                        elements.confirmAddModelBtn.addEventListener('click', addModel);
                    }
                    
                    // Confirm Delete Modal
                    if (elements.cancelDeleteBtn) {
                        elements.cancelDeleteBtn.addEventListener('click', hideConfirmDeleteModal);
                    }
                    if (elements.confirmDeleteBtn) {
                        elements.confirmDeleteBtn.addEventListener('click', executeDelete);
                    }
                    
                    // Initial character counts
                    if (elements.systemPrompt) {
                        updateCharCount(elements.systemPrompt);
                    }
                    if (elements.userPrompt) {
                        updateCharCount(elements.userPrompt);
                    }
                } catch (error) {
                    console.error('Error setting up API config event listeners:', error);
                }
            }

            function bindNewApiConfigButtons() {
                // 添加模型按钮
                const addModelToConfigBtn = document.getElementById('addModelToConfigBtn');
                if (addModelToConfigBtn) {
                    addModelToConfigBtn.addEventListener('click', addModelToTempList);
                }
                
                // 取消按钮
                const cancelNewApiConfigBtn = document.getElementById('cancelNewApiConfigBtn');
                if (cancelNewApiConfigBtn) {
                    cancelNewApiConfigBtn.addEventListener('click', function() {
                        const newApiConfigModal = document.getElementById('newApiConfigModal');
                        if (newApiConfigModal) {
                            newApiConfigModal.classList.add('hidden');
                        }
                    });
                }
                
                // 保存按钮
                const saveNewApiConfigBtn = document.getElementById('saveNewApiConfigBtn');
                if (saveNewApiConfigBtn) {
                    saveNewApiConfigBtn.addEventListener('click', addNewApiConfig);
                }
            }

            function updateCategorySelect() {
                // Clear current options
                elements.categorySelect.innerHTML = '<option value="">Select Category</option>';
                
                // Add options for each category
                state.categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    elements.categorySelect.appendChild(option);
                });
                
                // Set current category if there is one
                if (state.currentCategory) {
                    elements.categorySelect.value = state.currentCategory;
                }
                
                // Show/hide delete button based on selection
                elements.deleteCategoryBtn.style.visibility = state.currentCategory ? 'visible' : 'hidden';
            }

            function updatePromptSelect() {
                // Clear current options
                elements.promptSelect.innerHTML = '<option value="">Select Prompt</option>';
                
                // If no category is selected, return
                if (!state.currentCategory) return;
                
                // Get prompts for the current category
                const categoryPrompts = state.prompts[state.currentCategory] || [];
                
                // Add options for each prompt
                categoryPrompts.forEach(prompt => {
                    const option = document.createElement('option');
                    option.value = prompt.id;
                    option.textContent = prompt.name;
                    elements.promptSelect.appendChild(option);
                });
                
                // Set current prompt if there is one
                if (state.currentPrompt) {
                    elements.promptSelect.value = state.currentPrompt;
                }
                
                // Show/hide delete button based on selection
                elements.deletePromptBtn.style.visibility = state.currentPrompt ? 'visible' : 'hidden';
            }

            function updateStableVersionSelect() {
                // Clear current options
                elements.stableVersionSelect.innerHTML = '<option value="">Select Stable Version</option>';
                
                // If no prompt is selected, return
                if (!state.currentCategory || !state.currentPrompt) return;
                
                // Get the current prompt
                const categoryPrompts = state.prompts[state.currentCategory] || [];
                const currentPrompt = categoryPrompts.find(p => p.id === state.currentPrompt);
                
                if (!currentPrompt) return;
                
                // Add options for each stable version
                const stableVersions = currentPrompt.stableVersions || [];
                stableVersions.forEach(version => {
                    const option = document.createElement('option');
                    option.value = version.id;
                    option.textContent = version.name;
                    elements.stableVersionSelect.appendChild(option);
                });
                
                // Show/hide delete button based on selection
                const stableVersionId = elements.stableVersionSelect.value;
                elements.deleteStableVersionBtn.style.visibility = stableVersionId ? 'visible' : 'hidden';
            }

            function updateAvailableModels() {
                // Clear current models
                elements.availableModelsContainer.innerHTML = '';
                
                // Add each model
                state.models.forEach(model => {
                    const modelCard = document.createElement('div');
                    modelCard.className = 'flex justify-between items-center p-2 border border-gray-200 dark:border-gray-700 rounded';
                    
                    const modelInfo = document.createElement('div');
                    modelInfo.innerHTML = `
                        <div class="font-medium">${model.displayName || model.id}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">${model.id}</div>
                    `;
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-btn';
                    deleteBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                    deleteBtn.dataset.modelId = model.id;
                    deleteBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        showDeleteModelConfirm(model.id);
                    });
                    
                    modelCard.appendChild(modelInfo);
                    modelCard.appendChild(deleteBtn);
                    
                    elements.availableModelsContainer.appendChild(modelCard);
                });
            }

            function updateModelSelects() {
                // Clear current options
                elements.devModelSelect.innerHTML = '';
                elements.compareDevModelSelect.innerHTML = '';
                elements.compareStableModelSelect.innerHTML = '';
                
                // Add options for each API config and its models
                state.apiConfigs.forEach(config => {
                    // 创建配置组标签
                    const devOptgroup = document.createElement('optgroup');
                    devOptgroup.label = config.name;
                    
                    const compareDevOptgroup = document.createElement('optgroup');
                    compareDevOptgroup.label = config.name;
                    
                    const compareStableOptgroup = document.createElement('optgroup');
                    compareStableOptgroup.label = config.name;
                    
                    // 添加该配置下的所有模型
                    config.models.forEach(modelId => {
                        const devOption = document.createElement('option');
                        devOption.value = `${config.id}:${modelId}`;
                        devOption.textContent = modelId;
                        devOptgroup.appendChild(devOption);
                        
                        const compareDevOption = document.createElement('option');
                        compareDevOption.value = `${config.id}:${modelId}`;
                        compareDevOption.textContent = modelId;
                        compareDevOptgroup.appendChild(compareDevOption);
                        
                        const compareStableOption = document.createElement('option');
                        compareStableOption.value = `${config.id}:${modelId}`;
                        compareStableOption.textContent = modelId;
                        compareStableOptgroup.appendChild(compareStableOption);
                    });
                    
                    // 只有当配置有模型时才添加该组
                    if (config.models.length > 0) {
                        elements.devModelSelect.appendChild(devOptgroup);
                        elements.compareDevModelSelect.appendChild(compareDevOptgroup);
                        elements.compareStableModelSelect.appendChild(compareStableOptgroup);
                    }
                });
            }

            function onCategoryChange() {
                const categoryId = elements.categorySelect.value;
                state.currentCategory = categoryId;
                state.currentPrompt = null;
                
                // Update prompt select
                updatePromptSelect();
                
                // Update stable version select
                updateStableVersionSelect();
                
                // Clear the prompt editor
                clearPromptEditor();
                
                // Show/hide delete button based on selection
                elements.deleteCategoryBtn.style.visibility = categoryId ? 'visible' : 'hidden';
                elements.deletePromptBtn.style.visibility = 'hidden';
                
                saveState();
            }

            function onPromptChange() {
                const promptId = elements.promptSelect.value;
                state.currentPrompt = promptId;
                
                // Update the editor with the selected prompt
                loadPromptToEditor();
                
                // Update stable version select
                updateStableVersionSelect();
                
                // Show/hide delete button based on selection
                elements.deletePromptBtn.style.visibility = promptId ? 'visible' : 'hidden';
                
                saveState();
            }

            function loadPromptToEditor() {
                if (!state.currentCategory || !state.currentPrompt) {
                    clearPromptEditor();
                    return;
                }
                
                // Get the current prompt
                const categoryPrompts = state.prompts[state.currentCategory] || [];
                const currentPrompt = categoryPrompts.find(p => p.id === state.currentPrompt);
                
                if (!currentPrompt) {
                    clearPromptEditor();
                    return;
                }
                
                // Load development version
                const devVersion = currentPrompt.developmentVersion || {
                    systemPrompt: '',
                    userPrompt: '',
                    parameters: [
                        { key: 'temperature', value: '0.7' },
                        { key: 'top_p', value: '1' }
                    ]
                };
                
                // Set the editor values
                elements.systemPrompt.value = devVersion.systemPrompt || '';
                elements.userPrompt.value = devVersion.userPrompt || '';
                
                // Update character counts
                updateCharCount(elements.systemPrompt);
                updateCharCount(elements.userPrompt);
                
                // Set parameters
                updateParametersUI(devVersion.parameters || []);
                
                // Check for placeholders
                updatePlaceholderStatus();
            }

            function clearPromptEditor() {
                elements.systemPrompt.value = '';
                elements.userPrompt.value = '';
                
                // Reset parameters to defaults
                updateParametersUI([
                    { key: 'temperature', value: '0.7' },
                    { key: 'top_p', value: '1' }
                ]);
                
                // Hide response section
                elements.responseSection.classList.add('hidden');
                
                // Update character counts
                updateCharCount(elements.systemPrompt);
                updateCharCount(elements.userPrompt);
                
                // Update placeholder status
                updatePlaceholderStatus();
            }

            function updateParametersUI(parameters) {
                // Clear current parameters
                elements.parametersContainer.innerHTML = '';
                
                // Add each parameter
                parameters.forEach(param => {
                    const paramRow = document.createElement('div');
                    paramRow.className = 'parameter-row';
                    
                    const keyInput = document.createElement('input');
                    keyInput.type = 'text';
                    keyInput.value = param.key;
                    keyInput.className = 'parameter-key';
                    keyInput.readOnly = true;
                    
                    const valueInput = document.createElement('input');
                    valueInput.type = 'text';
                    valueInput.value = param.value;
                    valueInput.className = 'parameter-value';
                    valueInput.addEventListener('input', saveDevelopmentVersion);
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'remove-parameter text-red-500 hover:text-red-700';
                    removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                    removeBtn.addEventListener('click', removeParameter);
                    
                    paramRow.appendChild(keyInput);
                    paramRow.appendChild(valueInput);
                    paramRow.appendChild(removeBtn);
                    
                    elements.parametersContainer.appendChild(paramRow);
                });
            }

            function saveDevelopmentVersion() {
                if (!state.currentCategory || !state.currentPrompt) return;
                
                // Get the current parameters
                const parameters = [];
                document.querySelectorAll('.parameter-row').forEach(row => {
                    const key = row.querySelector('.parameter-key').value;
                    const value = row.querySelector('.parameter-value').value;
                    parameters.push({ key, value });
                });
                
                // Create development version
                const devVersion = {
                    systemPrompt: elements.systemPrompt.value,
                    userPrompt: elements.userPrompt.value,
                    parameters
                };
                
                // Save to the current prompt
                const categoryPrompts = state.prompts[state.currentCategory] || [];
                const promptIndex = categoryPrompts.findIndex(p => p.id === state.currentPrompt);
                
                if (promptIndex !== -1) {
                    categoryPrompts[promptIndex].developmentVersion = devVersion;
                    saveState();
                }
            }

            function showNewCategoryModal() {
                elements.newCategoryName.value = '';
                elements.newCategoryModal.classList.remove('hidden');
            }

            function hideNewCategoryModal() {
                elements.newCategoryModal.classList.add('hidden');
            }

            function createNewCategory() {
                const categoryName = elements.newCategoryName.value.trim();
                
                if (!categoryName) {
                    showToast('Category name cannot be empty', 'error');
                    return;
                }
                
                // Check if category already exists
                if (state.categories.some(c => c.name === categoryName)) {
                    showToast('A category with this name already exists', 'error');
                    return;
                }
                
                // Create new category
                const newCategory = {
                    id: generateId(),
                    name: categoryName
                };
                
                // Add to state
                state.categories.push(newCategory);
                state.currentCategory = newCategory.id;
                state.currentPrompt = null;
                
                // Initialize prompts for this category
                state.prompts[newCategory.id] = [];
                
                // Update UI
                updateCategorySelect();
                updatePromptSelect();
                clearPromptEditor();
                
                // Save state
                saveState();
                
                // Hide modal
                hideNewCategoryModal();
                
                // Show toast
                showToast(`Category "${categoryName}" created`);
            }

            function showNewPromptModal() {
                if (!state.currentCategory) {
                    showToast('Please select a category first', 'error');
                    return;
                }
                
                elements.newPromptName.value = '';
                elements.newPromptModal.classList.remove('hidden');
            }

            function hideNewPromptModal() {
                elements.newPromptModal.classList.add('hidden');
            }

            function createNewPrompt() {
                const promptName = elements.newPromptName.value.trim();
                
                if (!promptName) {
                    showToast('Prompt name cannot be empty', 'error');
                    return;
                }
                
                // Check if prompt already exists in this category
                const categoryPrompts = state.prompts[state.currentCategory] || [];
                if (categoryPrompts.some(p => p.name === promptName)) {
                    showToast('A prompt with this name already exists in this category', 'error');
                    return;
                }
                
                // Create new prompt
                const newPrompt = {
                    id: generateId(),
                    name: promptName,
                    developmentVersion: {
                        systemPrompt: '',
                        userPrompt: '',
                        parameters: [
                            { key: 'temperature', value: '0.7' },
                            { key: 'top_p', value: '1' }
                        ]
                    },
                    stableVersions: []
                };
                
                // Add to state
                if (!state.prompts[state.currentCategory]) {
                    state.prompts[state.currentCategory] = [];
                }
                
                state.prompts[state.currentCategory].push(newPrompt);
                state.currentPrompt = newPrompt.id;
                
                // Update UI
                updatePromptSelect();
                loadPromptToEditor();
                
                // Save state
                saveState();
                
                // Hide modal
                hideNewPromptModal();
                
                // Show toast
                showToast(`Prompt "${promptName}" created`);
            }

            function showSaveVersionModal() {
                if (!state.currentCategory || !state.currentPrompt) {
                    showToast('Please select a prompt first', 'error');
                    return;
                }
                
                elements.versionName.value = '';
                elements.versionDescription.value = '';
                elements.saveVersionModal.classList.remove('hidden');
            }

            function hideSaveVersionModal() {
                elements.saveVersionModal.classList.add('hidden');
            }

            function saveStableVersion() {
                const versionName = elements.versionName.value.trim();
                const versionDescription = elements.versionDescription.value.trim();
                
                if (!versionName) {
                    showToast('Version name cannot be empty', 'error');
                    return;
                }
                
                if (!state.currentCategory || !state.currentPrompt) {
                    showToast('No prompt selected', 'error');
                    return;
                }
                
                // Get the current prompt
                const categoryPrompts = state.prompts[state.currentCategory] || [];
                const promptIndex = categoryPrompts.findIndex(p => p.id === state.currentPrompt);
                
                if (promptIndex === -1) {
                    showToast('Current prompt not found', 'error');
                    return;
                }
                
                const currentPrompt = categoryPrompts[promptIndex];
                
                // Check if version name already exists
                if (currentPrompt.stableVersions && currentPrompt.stableVersions.some(v => v.name === versionName)) {
                    showToast('A version with this name already exists', 'error');
                    return;
                }
                
                // Create new stable version
                const newVersion = {
                    id: generateId(),
                    name: versionName,
                    description: versionDescription,
                    createdAt: new Date().toISOString(),
                    categoryId: state.currentCategory, // Store category ID with the version
                    ...currentPrompt.developmentVersion
                };
                
                // Add to prompt
                if (!currentPrompt.stableVersions) {
                    currentPrompt.stableVersions = [];
                }
                
                currentPrompt.stableVersions.push(newVersion);
                
                // Update UI
                updateStableVersionSelect();
                
                // Save state
                saveState();
                
                // Hide modal
                hideSaveVersionModal();
                
                // Show toast
                showToast(`Stable version "${versionName}" saved`);
            }

            function showAddParameterModal() {
                elements.newParameterName.value = '';
                elements.newParameterValue.value = '';
                elements.addParameterModal.classList.remove('hidden');
            }

            function hideAddParameterModal() {
                elements.addParameterModal.classList.add('hidden');
            }

            function showAddModelModal() {
                elements.newModelName.value = '';
                elements.newModelDisplayName.value = '';
                elements.addModelModal.classList.remove('hidden');
            }

            function hideAddModelModal() {
                elements.addModelModal.classList.add('hidden');
            }

            function addModel() {
                const modelName = elements.newModelName.value.trim();
                const displayName = elements.newModelDisplayName.value.trim();
                
                if (!modelName) {
                    showToast('Model name cannot be empty', 'error');
                    return;
                }
                
                // Check if model already exists
                if (state.models.some(m => m.id === modelName)) {
                    showToast('This model already exists', 'error');
                    return;
                }
                
                // Create new model
                const newModel = {
                    id: modelName,
                    displayName: displayName || modelName
                };
                
                // Add to state
                state.models.push(newModel);
                
                // Update UI
                updateAvailableModels();
                updateModelSelects();
                
                // Save state
                saveState();
                
                // Hide modal
                hideAddModelModal();
                
                // Show toast
                showToast(`Model "${modelName}" added`);
            }

            function showDeleteModelConfirm(modelId) {
                // Find the model
                const model = state.models.find(m => m.id === modelId);
                if (!model) {
                    showToast('Model not found', 'error');
                    return;
                }
                
                // Set up confirm delete modal
                state.deleteType = 'model';
                state.deleteTarget = modelId;
                elements.confirmDeleteMessage.textContent = `Are you sure you want to delete the model "${model.displayName || model.id}"?`;
                
                // Show modal
                elements.confirmDeleteModal.classList.remove('hidden');
            }

            function deleteModel() {
                const modelId = state.deleteTarget;
                const modelIndex = state.models.findIndex(m => m.id === modelId);
                
                if (modelIndex === -1) {
                    showToast('Model not found', 'error');
                    return;
                }
                
                // Get model name for the toast
                const modelName = state.models[modelIndex].displayName || state.models[modelIndex].id;
                
                // Remove model
                state.models.splice(modelIndex, 1);
                
                // If this was the selected model, reset to the first available
                if (state.currentDevModel === modelId && state.models.length > 0) {
                    state.currentDevModel = state.models[0].id;
                } else if (state.models.length === 0) {
                    state.currentDevModel = null;
                }
                
                if (state.currentCompareDevModel === modelId && state.models.length > 0) {
                    state.currentCompareDevModel = state.models[0].id;
                } else if (state.models.length === 0) {
                    state.currentCompareDevModel = null;
                }
                
                if (state.currentCompareStableModel === modelId && state.models.length > 0) {
                    state.currentCompareStableModel = state.models[0].id;
                } else if (state.models.length === 0) {
                    state.currentCompareStableModel = null;
                }
                
                // Update UI
                updateAvailableModels();
                updateModelSelects();
                
                // Save state
                saveState();
                
                // Show toast
                showToast(`Model "${modelName}" deleted`);
            }

            function addParameter() {
                const paramName = elements.newParameterName.value.trim();
                const paramValue = elements.newParameterValue.value.trim();
                
                if (!paramName) {
                    showToast('Parameter name cannot be empty', 'error');
                    return;
                }
                
                // Check if parameter already exists
                const exists = Array.from(document.querySelectorAll('.parameter-key')).some(
                    input => input.value === paramName
                );
                
                if (exists) {
                    showToast('This parameter already exists', 'error');
                    return;
                }
                
                // Create parameter row
                const paramRow = document.createElement('div');
                paramRow.className = 'parameter-row';
                
                const keyInput = document.createElement('input');
                keyInput.type = 'text';
                keyInput.value = paramName;
                keyInput.className = 'parameter-key';
                keyInput.readOnly = true;
                
                const valueInput = document.createElement('input');
                valueInput.type = 'text';
                valueInput.value = paramValue;
                valueInput.className = 'parameter-value';
                valueInput.addEventListener('input', saveDevelopmentVersion);
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-parameter text-red-500 hover:text-red-700';
                removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                removeBtn.addEventListener('click', removeParameter);
                
                paramRow.appendChild(keyInput);
                paramRow.appendChild(valueInput);
                paramRow.appendChild(removeBtn);
                
                elements.parametersContainer.appendChild(paramRow);
                
                // Save development version
                saveDevelopmentVersion();
                
                // Hide modal
                hideAddParameterModal();
                
                // Show toast
                showToast(`Parameter "${paramName}" added`);
            }

            function removeParameter(event) {
                const paramRow = event.currentTarget.closest('.parameter-row');
                const paramName = paramRow.querySelector('.parameter-key').value;
                
                // Remove from DOM
                paramRow.remove();
                
                // Save development version
                saveDevelopmentVersion();
                
                // Show toast
                showToast(`Parameter "${paramName}" removed`);
            }


            function switchMode(compareMode) {
                state.compareMode = compareMode;
                
                if (compareMode) {
                    // Switch to compare mode
                    elements.editModeBtn.classList.remove('border-blue-500', 'text-blue-500');
                    elements.editModeBtn.classList.add('border-transparent', 'text-gray-500', 'dark:text-gray-400');
                    
                    elements.compareModeBtn.classList.remove('border-transparent', 'text-gray-500', 'dark:text-gray-400');
                    elements.compareModeBtn.classList.add('border-blue-500', 'text-blue-500');
                    
                    elements.editModeContent.classList.add('hidden');
                    elements.compareModeContent.classList.remove('hidden');
                    
                    // Update comparison view
                    updateComparisonView();
                } else {
                    // Switch to edit mode
                    elements.compareModeBtn.classList.remove('border-blue-500', 'text-blue-500');
                    elements.compareModeBtn.classList.add('border-transparent', 'text-gray-500', 'dark:text-gray-400');
                    
                    elements.editModeBtn.classList.remove('border-transparent', 'text-gray-500', 'dark:text-gray-400');
                    elements.editModeBtn.classList.add('border-blue-500', 'text-blue-500');
                    
                    elements.compareModeContent.classList.add('hidden');
                    elements.editModeContent.classList.remove('hidden');
                }
            }

            function updateComparisonView() {
                if (!state.currentCategory || !state.currentPrompt) {
                    return;
                }
                
                // Get the current prompt
                const categoryPrompts = state.prompts[state.currentCategory] || [];
                const currentPrompt = categoryPrompts.find(p => p.id === state.currentPrompt);
                
                if (!currentPrompt) return;
                
                // Update development version view
                const devVersion = currentPrompt.developmentVersion || {
                    systemPrompt: '',
                    userPrompt: '',
                    parameters: []
                };
                
                elements.compareDevSystemPrompt.textContent = devVersion.systemPrompt || '';
                elements.compareDevUserPrompt.textContent = devVersion.userPrompt || '';
                elements.compareDevParams.innerHTML = '';
                
                // Display parameters
                devVersion.parameters.forEach(param => {
                    const paramItem = document.createElement('div');
                    paramItem.className = 'mb-1';
                    paramItem.textContent = `${param.key}: ${param.value}`;
                    elements.compareDevParams.appendChild(paramItem);
                });
                
                // Hide dev response section
                elements.compareDevResponseSection.classList.add('hidden');
                
                // Update stable version view if one is selected
                const stableVersionId = elements.stableVersionSelect.value;
                if (stableVersionId) {
                    const stableVersion = currentPrompt.stableVersions.find(v => v.id === stableVersionId);
                    
                    if (stableVersion) {
                        elements.compareStableSystemPrompt.textContent = stableVersion.systemPrompt || '';
                        elements.compareStableUserPrompt.textContent = stableVersion.userPrompt || '';
                        elements.compareStableParams.innerHTML = '';
                        
                        // Display parameters
                        stableVersion.parameters.forEach(param => {
                            const paramItem = document.createElement('div');
                            paramItem.className = 'mb-1';
                            paramItem.textContent = `${param.key}: ${param.value}`;
                            elements.compareStableParams.appendChild(paramItem);
                        });
                    }
                } else {
                    elements.compareStableSystemPrompt.textContent = '';
                    elements.compareStableUserPrompt.textContent = '';
                    elements.compareStableParams.innerHTML = '';
                }
                
                // Show/hide delete button based on selection
                elements.deleteStableVersionBtn.style.visibility = stableVersionId ? 'visible' : 'hidden';
                
                // Hide stable response section
                elements.compareStableResponseSection.classList.add('hidden');
                
                // Check for placeholders in both prompts
                checkComparisonPlaceholders();
            }

            function updatePlaceholderStatus() {
                const systemPrompt = elements.systemPrompt.value;
                const userPrompt = elements.userPrompt.value;
                
                // Check for placeholders
                const placeholders = extractPlaceholders(systemPrompt, userPrompt);
                
                if (placeholders.length > 0) {
                    elements.placeholderStatus.textContent = `Found placeholders: ${placeholders.join(', ')}`;
                    elements.testInputSection.classList.remove('hidden');
                } else {
                    elements.placeholderStatus.textContent = 'No placeholders detected';
                    // Don't hide the test input section, just indicate it's optional
                }
            }

            function checkComparisonPlaceholders() {
                const systemPromptDev = elements.compareDevSystemPrompt.textContent;
                const userPromptDev = elements.compareDevUserPrompt.textContent;
                
                const systemPromptStable = elements.compareStableSystemPrompt.textContent;
                const userPromptStable = elements.compareStableUserPrompt.textContent;
                
                // Check for placeholders in both versions
                const placeholdersDev = extractPlaceholders(systemPromptDev, userPromptDev);
                const placeholdersStable = extractPlaceholders(systemPromptStable, userPromptStable);
                
                // Combine unique placeholders
                const allPlaceholders = [...new Set([...placeholdersDev, ...placeholdersStable])];
                
                if (allPlaceholders.length > 0) {
                    elements.comparePlaceholderStatus.textContent = `Found placeholders: ${allPlaceholders.join(', ')}`;
                } else {
                    elements.comparePlaceholderStatus.textContent = 'No placeholders detected';
                    // Don't hide the test input, just indicate it's optional
                }
            }

            function extractPlaceholders(systemPrompt, userPrompt) {
                const regex = /\${([^}]+)}/g;
                const placeholders = [];
                
                // Extract from system prompt
                let match;
                while ((match = regex.exec(systemPrompt)) !== null) {
                    placeholders.push(match[1]);
                }
                
                // Reset regex
                regex.lastIndex = 0;
                
                // Extract from user prompt
                while ((match = regex.exec(userPrompt)) !== null) {
                    placeholders.push(match[1]);
                }
                
                // Return unique placeholders
                return [...new Set(placeholders)];
            }

            function validateJsonInput(event, isCompare = false) {
                const inputElement = isCompare ? elements.compareTestInput : elements.testInput;
                const errorElement = isCompare ? elements.compareJsonValidationError : elements.jsonValidationError;
                
                const jsonStr = inputElement.value.trim();
                
                // If empty, hide error
                if (!jsonStr) {
                    errorElement.classList.add('hidden');
                    return true;
                }
                
                try {
                    JSON.parse(jsonStr);
                    errorElement.classList.add('hidden');
                    return true;
                } catch (error) {
                    errorElement.textContent = 'Invalid JSON format';
                    errorElement.classList.remove('hidden');
                    return false;
                }
            }

            function applyPlaceholders(text, placeholderValues) {
                if (!text || !placeholderValues) return text;
                
                return text.replace(/\${([^}]+)}/g, (match, placeholder) => {
                    return placeholderValues[placeholder] !== undefined 
                        ? placeholderValues[placeholder] 
                        : match;
                });
            }

            async function testPrompt() {
                if (!state.currentCategory || !state.currentPrompt) {
                    showToast('Please select a prompt first', 'error');
                    return;
                }
                
                // Get placeholder values
                let placeholderValues = {};
                const jsonStr = elements.testInput.value.trim();
                
                if (jsonStr) {
                    try {
                        placeholderValues = JSON.parse(jsonStr);
                    } catch (error) {
                        showToast('Invalid JSON in test input', 'error');
                        return;
                    }
                }
                
                // Get the current prompt
                const categoryPrompts = state.prompts[state.currentCategory] || [];
                const currentPrompt = categoryPrompts.find(p => p.id === state.currentPrompt);
                
                if (!currentPrompt || !currentPrompt.developmentVersion) {
                    showToast('Development version not found', 'error');
                    return;
                }
                
                const devVersion = currentPrompt.developmentVersion;
                
                // Apply placeholders
                const systemPrompt = applyPlaceholders(devVersion.systemPrompt, placeholderValues);
                const userPrompt = applyPlaceholders(devVersion.userPrompt, placeholderValues);
                
                // Get parameters
                const parameters = {};
                devVersion.parameters.forEach(param => {
                    if (param.value.trim()) {
                        // Try to parse as number or boolean if possible
                        let value = param.value;
                        if (value === 'true') value = true;
                        else if (value === 'false') value = false;
                        else if (!isNaN(value) && value.trim() !== '') value = parseFloat(value);
                        
                        parameters[param.key] = value;
                    }
                });
                
                // Get selected model
                const selectedModel = elements.devModelSelect.value;
                
                // Update model badge
                const [configId, modelId] = selectedModel.split(':');
                const apiConfig = state.apiConfigs.find(config => config.id === configId);
                const configName = apiConfig ? apiConfig.name : configId;
                const modelDisplayName = `${configName}:${modelId}`;
                elements.responseModelBadge.textContent = modelDisplayName;
                
                // Show loading state
                elements.responseContainer.innerHTML = '<div class="flex justify-center my-4"><div class="loading-indicator"></div> Generating response...</div>';
                elements.responseSection.classList.remove('hidden');
                elements.responseStats.textContent = 'Processing...';
                
                const startTime = performance.now();
                
                try {
                    // Make API request with the selected model
                    const response = await callApi(systemPrompt, userPrompt, parameters, selectedModel);
                    
                    const endTime = performance.now();
                    const duration = ((endTime - startTime) / 1000).toFixed(2);
                    
                    // Update response UI
                    elements.responseStats.textContent = `Completed in ${duration}s`;
                    elements.responseContainer.textContent = response;
                    elements.responseSection.classList.remove('hidden');
                } catch (error) {
                    elements.responseStats.textContent = 'Error';
                    elements.responseContainer.textContent = `Error: ${error.message}`;
                    showToast('API request failed: ' + error.message, 'error');
                }
            }

            async function runComparison() {
                if (!state.currentCategory || !state.currentPrompt) {
                    showToast('Please select a prompt first', 'error');
                    return;
                }
                
                const stableVersionId = elements.stableVersionSelect.value;
                if (!stableVersionId) {
                    showToast('Please select a stable version to compare', 'error');
                    return;
                }
                
                // Get placeholder values
                let placeholderValues = {};
                const jsonStr = elements.compareTestInput.value.trim();
                
                if (jsonStr) {
                    try {
                        placeholderValues = JSON.parse(jsonStr);
                    } catch (error) {
                        showToast('Invalid JSON in test input', 'error');
                        return;
                    }
                }
                
                // Get the current prompt
                const categoryPrompts = state.prompts[state.currentCategory] || [];
                const currentPrompt = categoryPrompts.find(p => p.id === state.currentPrompt);
                
                if (!currentPrompt) {
                    showToast('Current prompt not found', 'error');
                    return;
                }
                
                // Get development version
                const devVersion = currentPrompt.developmentVersion;
                if (!devVersion) {
                    showToast('Development version not found', 'error');
                    return;
                }
                
                // Get stable version
                const stableVersion = currentPrompt.stableVersions.find(v => v.id === stableVersionId);
                if (!stableVersion) {
                    showToast('Stable version not found', 'error');
                    return;
                }
                
                // Apply placeholders
                const devSystemPrompt = applyPlaceholders(devVersion.systemPrompt, placeholderValues);
                const devUserPrompt = applyPlaceholders(devVersion.userPrompt, placeholderValues);
                
                const stableSystemPrompt = applyPlaceholders(stableVersion.systemPrompt, placeholderValues);
                const stableUserPrompt = applyPlaceholders(stableVersion.userPrompt, placeholderValues);
                
                // Get parameters
                const devParameters = {};
                devVersion.parameters.forEach(param => {
                    if (param.value.trim()) {
                        // Try to parse as number or boolean if possible
                        let value = param.value;
                        if (value === 'true') value = true;
                        else if (value === 'false') value = false;
                        else if (!isNaN(value) && value.trim() !== '') value = parseFloat(value);
                        
                        devParameters[param.key] = value;
                    }
                });
                
                const stableParameters = {};
                stableVersion.parameters.forEach(param => {
                    if (param.value.trim()) {
                        // Try to parse as number or boolean if possible
                        let value = param.value;
                        if (value === 'true') value = true;
                        else if (value === 'false') value = false;
                        else if (!isNaN(value) && value.trim() !== '') value = parseFloat(value);
                        
                        stableParameters[param.key] = value;
                    }
                });
                
                // Get selected models
                const devModel = elements.compareDevModelSelect.value;
                const stableModel = elements.compareStableModelSelect.value;
                
                // Update model badges
                let devModelDisplayName, stableModelDisplayName;
                
                if (devModel) {
                    const [devConfigId, devModelId] = devModel.split(':');
                    const devApiConfig = state.apiConfigs.find(config => config.id === devConfigId);
                    const devConfigName = devApiConfig ? devApiConfig.name : devConfigId;
                    devModelDisplayName = `${devConfigName}:${devModelId}`;
                } else {
                    devModelDisplayName = "未选择";
                }
                
                if (stableModel) {
                    const [stableConfigId, stableModelId] = stableModel.split(':');
                    const stableApiConfig = state.apiConfigs.find(config => config.id === stableConfigId);
                    const stableConfigName = stableApiConfig ? stableApiConfig.name : stableConfigId;
                    stableModelDisplayName = `${stableConfigName}:${stableModelId}`;
                } else {
                    stableModelDisplayName = "未选择";
                }
                
                elements.compareDevModelBadge.textContent = devModelDisplayName;
                elements.compareStableModelBadge.textContent = stableModelDisplayName;
                
                // Show loading state for both
                elements.compareDevResponseContainer.innerHTML = '<div class="flex justify-center my-4"><div class="loading-indicator"></div> Generating response...</div>';
                elements.compareDevResponseSection.classList.remove('hidden');
                elements.compareDevResponseStats.textContent = 'Processing...';
                
                elements.compareStableResponseContainer.innerHTML = '<div class="flex justify-center my-4"><div class="loading-indicator"></div> Generating response...</div>';
                elements.compareStableResponseSection.classList.remove('hidden');
                elements.compareStableResponseStats.textContent = 'Processing...';
                
                const devStartTime = performance.now();
                const stableStartTime = performance.now();
                
                // Make both API calls concurrently
                try {
                    const [devResponse, stableResponse] = await Promise.all([
                        callApi(devSystemPrompt, devUserPrompt, devParameters, devModel),
                        callApi(stableSystemPrompt, stableUserPrompt, stableParameters, stableModel)
                    ]);
                    
                    const devEndTime = performance.now();
                    const stableEndTime = performance.now();
                    
                    const devDuration = ((devEndTime - devStartTime) / 1000).toFixed(2);
                    const stableDuration = ((stableEndTime - stableStartTime) / 1000).toFixed(2);
                    
                    // Update dev response UI
                    elements.compareDevResponseStats.textContent = `Completed in ${devDuration}s`;
                    elements.compareDevResponseContainer.textContent = devResponse;
                    
                    // Update stable response UI
                    elements.compareStableResponseStats.textContent = `Completed in ${stableDuration}s`;
                    elements.compareStableResponseContainer.textContent = stableResponse;
                } catch (error) {
                    showToast('API request failed: ' + error.message, 'error');
                    
                    // Update error state in both containers
                    elements.compareDevResponseStats.textContent = 'Error';
                    elements.compareDevResponseContainer.textContent = `Error: ${error.message}`;
                    
                    elements.compareStableResponseStats.textContent = 'Error';
                    elements.compareStableResponseContainer.textContent = `Error: ${error.message}`;
                }
            }

            async function callApi(systemPrompt, userPrompt, parameters, modelOverride = null) {
                if (!modelOverride) {
                    throw new Error('请选择模型');
                }
                
                // 解析模型选择值: configId:modelId
                const [configId, modelId] = modelOverride.split(':');
                
                // 获取对应的API配置
                const apiConfig = state.apiConfigs.find(config => config.id === configId);
                
                if (!apiConfig) {
                    throw new Error('找不到API配置');
                }
                
                const { baseURL, apiKey } = apiConfig;
                
                if (!baseURL || !apiKey) {
                    throw new Error('API配置不完整');
                }
                
                const endpoint = `${baseURL}/chat/completions`;
                
                const headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                };
                
                // 创建消息数组，只有在systemPrompt非空时才添加system消息
                const messages = [];
                if (systemPrompt && systemPrompt.trim()) {
                    messages.push({ role: 'system', content: systemPrompt });
                }
                messages.push({ role: 'user', content: userPrompt });
                
                const requestBody = {
                    model: modelId,
                    messages: messages,
                    ...parameters
                };
                
                try {
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(requestBody)
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error?.message || `API request failed with status ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                        throw new Error('Invalid response format from API');
                    }
                    
                    return data.choices[0].message.content;
                } catch (error) {
                    console.error('API call error:', error);
                    throw error;
                }
            }

            function copyResponse() {
                const text = elements.responseContainer.textContent;
                navigator.clipboard.writeText(text)
                    .then(() => {
                        showToast('Response copied to clipboard');
                    })
                    .catch(() => {
                        showToast('Failed to copy response', 'error');
                    });
            }

            function toggleDarkMode() {
                state.darkMode = !state.darkMode;
                setDarkMode(state.darkMode);
                localStorage.setItem('darkMode', state.darkMode);
            }

            function setDarkMode(enabled) {
                if (enabled) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }

            function updateCharCount(textarea) {
                const count = textarea.value.length;
                const countEl = textarea.parentElement.querySelector('.char-count');
                if (countEl) {
                    countEl.textContent = `${count} characters`;
                }
            }

            function showToast(message, type = 'success') {
                const toast = elements.toast;
                toast.textContent = message;
                
                if (type === 'error') {
                    toast.classList.add('bg-red-500');
                    toast.classList.remove('bg-blue-500', 'bg-green-500');
                } else if (type === 'info') {
                    toast.classList.add('bg-blue-500');
                    toast.classList.remove('bg-red-500', 'bg-green-500');
                } else {
                    toast.classList.add('bg-green-500');
                    toast.classList.remove('bg-red-500', 'bg-blue-500');
                }
                
                toast.classList.add('show');
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }

            function generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
            }
            
            // Delete functions
            
            function showDeleteCategoryConfirm() {
                if (!state.currentCategory) {
                    showToast('No category selected', 'error');
                    return;
                }
                
                // Get category name
                const category = state.categories.find(c => c.id === state.currentCategory);
                if (!category) {
                    showToast('Category not found', 'error');
                    return;
                }
                
                // Set up confirm delete modal
                state.deleteType = 'category';
                state.deleteTarget = state.currentCategory;
                const confirmDeleteMessage = document.getElementById('confirmDeleteMessage');
                if (confirmDeleteMessage) {
                    confirmDeleteMessage.textContent = `确定要删除类别 "${category.name}" 吗？这将同时删除该类别下的所有提示和稳定版本。`;
                }
                
                // Show modal
                const confirmDeleteModal = document.getElementById('confirmDeleteModal');
                if (confirmDeleteModal) {
                    confirmDeleteModal.style.display = 'flex';
                    confirmDeleteModal.classList.remove('hidden');
                }
            }
            
            function showDeletePromptConfirm() {
                if (!state.currentCategory || !state.currentPrompt) {
                    showToast('No prompt selected', 'error');
                    return;
                }
                
                // Get prompt name
                const categoryPrompts = state.prompts[state.currentCategory] || [];
                const prompt = categoryPrompts.find(p => p.id === state.currentPrompt);
                if (!prompt) {
                    showToast('Prompt not found', 'error');
                    return;
                }
                
                // Set up confirm delete modal
                state.deleteType = 'prompt';
                state.deleteTarget = state.currentPrompt;
                const confirmDeleteMessage = document.getElementById('confirmDeleteMessage');
                if (confirmDeleteMessage) {
                    confirmDeleteMessage.textContent = `确定要删除提示 "${prompt.name}" 吗？这将同时删除该提示的所有稳定版本。`;
                }
                
                // Show modal
                const confirmDeleteModal = document.getElementById('confirmDeleteModal');
                if (confirmDeleteModal) {
                    confirmDeleteModal.style.display = 'flex';
                }
            }
            
            function showDeleteStableVersionConfirm() {
                if (!state.currentCategory || !state.currentPrompt) {
                    showToast('No prompt selected', 'error');
                    return;
                }
                
                // Get stable version
                const categoryPrompts = state.prompts[state.currentCategory] || [];
                const currentPrompt = categoryPrompts.find(p => p.id === state.currentPrompt);
                if (!currentPrompt) {
                    showToast('Current prompt not found', 'error');
                    return;
                }
                
                const stableVersionId = elements.stableVersionSelect.value;
                const stableVersion = currentPrompt.stableVersions.find(v => v.id === stableVersionId);
                if (!stableVersion) {
                    showToast('Stable version not found', 'error');
                    return;
                }
                
                // Set up confirm delete modal
                state.deleteType = 'stableVersion';
                state.deleteTarget = stableVersionId;
                
                const confirmDeleteMessage = document.getElementById('confirmDeleteMessage');
                if (confirmDeleteMessage) {
                    confirmDeleteMessage.textContent = `确定要删除稳定版本 "${stableVersion.name}" 吗？`;
                }
                
                // Show modal
                const confirmDeleteModal = document.getElementById('confirmDeleteModal');
                if (confirmDeleteModal) {
                    confirmDeleteModal.style.display = 'flex';
                }
            }
            
            function hideConfirmDeleteModal() {
                const confirmDeleteModal = document.getElementById('confirmDeleteModal');
                if (confirmDeleteModal) {
                    confirmDeleteModal.style.display = 'none';
                    confirmDeleteModal.classList.add('hidden');
                }
            }
            
            function executeDelete() {
                if (!state.deleteType || !state.deleteTarget) {
                    hideConfirmDeleteModal();
                    return;
                }
                
                if (state.deleteType === 'category') {
                    deleteCategory();
                } else if (state.deleteType === 'prompt') {
                    deletePrompt();
                } else if (state.deleteType === 'stableVersion') {
                    deleteStableVersion();
                } else if (state.deleteType === 'model') {
                    deleteModel();
                } else if (state.deleteType === 'apiConfig') {
                    deleteApiConfig();
                }
                
                // Hide modal
                hideConfirmDeleteModal();
            }
            
            function deleteCategory() {
                const categoryId = state.deleteTarget;
                const categoryIndex = state.categories.findIndex(c => c.id === categoryId);
                
                if (categoryIndex === -1) {
                    showToast('Category not found', 'error');
                    return;
                }
                
                // Get category name for the toast
                const categoryName = state.categories[categoryIndex].name;
                
                // Remove category
                state.categories.splice(categoryIndex, 1);
                
                // Remove prompts
                delete state.prompts[categoryId];
                
                // Reset current selections if needed
                if (state.currentCategory === categoryId) {
                    state.currentCategory = null;
                    state.currentPrompt = null;
                }
                
                // Update UI
                updateCategorySelect();
                updatePromptSelect();
                clearPromptEditor();
                
                // Save state
                saveState();
                
                // Show toast
                showToast(`Category "${categoryName}" deleted`);
            }
            
            function deletePrompt() {
                const promptId = state.deleteTarget;
                
                if (!state.currentCategory) {
                    showToast('No category selected', 'error');
                    return;
                }
                
                const categoryPrompts = state.prompts[state.currentCategory] || [];
                const promptIndex = categoryPrompts.findIndex(p => p.id === promptId);
                
                if (promptIndex === -1) {
                    showToast('Prompt not found', 'error');
                    return;
                }
                
                // Get prompt name for the toast
                const promptName = categoryPrompts[promptIndex].name;
                
                // Remove prompt
                categoryPrompts.splice(promptIndex, 1);
                
                // Reset current prompt if needed
                if (state.currentPrompt === promptId) {
                    state.currentPrompt = null;
                }
                
                // Update UI
                updatePromptSelect();
                clearPromptEditor();
                
                // Save state
                saveState();
                
                // Show toast
                showToast(`Prompt "${promptName}" deleted`);
            }
            
            function deleteStableVersion() {
                const versionId = state.deleteTarget;
                
                if (!state.currentCategory || !state.currentPrompt) {
                    showToast('No prompt selected', 'error');
                    return;
                }
                
                const categoryPrompts = state.prompts[state.currentCategory] || [];
                const prompt = categoryPrompts.find(p => p.id === state.currentPrompt);
                
                if (!prompt || !prompt.stableVersions) {
                    showToast('Prompt not found', 'error');
                    return;
                }
                
                const versionIndex = prompt.stableVersions.findIndex(v => v.id === versionId);
                
                if (versionIndex === -1) {
                    showToast('Stable version not found', 'error');
                    return;
                }
                
                // Get version name for the toast
                const versionName = prompt.stableVersions[versionIndex].name;
                
                // Remove version
                prompt.stableVersions.splice(versionIndex, 1);
                
                // Update UI
                updateStableVersionSelect();
                if (state.compareMode) {
                    updateComparisonView();
                }
                
                // Save state
                saveState();
                
                // Show toast
                showToast(`Stable version "${versionName}" deleted`);
            }

            // Initial setup of delete buttons visibility
            elements.deleteCategoryBtn.style.visibility = state.currentCategory ? 'visible' : 'hidden';
            elements.deletePromptBtn.style.visibility = state.currentPrompt ? 'visible' : 'hidden';
            elements.deleteStableVersionBtn.style.visibility = 'hidden';
            
            // Add event listener for stableVersionSelect to update delete button visibility
            elements.stableVersionSelect.addEventListener('change', () => {
                const stableVersionId = elements.stableVersionSelect.value;
                elements.deleteStableVersionBtn.style.visibility = stableVersionId ? 'visible' : 'hidden';
            });

            // New API Config Modal functions
            function showApiConfigModal() {
                console.log('Showing API config modal');
                try {
                    updateApiConfigsDisplay();
                    if (elements.apiConfigModal) {
                        elements.apiConfigModal.classList.remove('hidden');
                        console.log('API config modal displayed');
                    } else {
                        console.error('API config modal element not found');
                    }
                } catch (error) {
                    console.error('Error showing API config modal:', error);
                    // 直接通过DOM查询找到元素
                    try {
                        const modal = document.getElementById('apiConfigModal');
                        if (modal) {
                            modal.classList.remove('hidden');
                            console.log('API config modal displayed through direct DOM query');
                        } else {
                            console.error('API config modal not found in DOM');
                        }
                    } catch (e) {
                        console.error('Error in fallback display:', e);
                    }
                }
            }
            
            function hideApiConfigModal() {
                console.log('Hiding API config modal');
                try {
                    if (elements.apiConfigModal) {
                        elements.apiConfigModal.classList.add('hidden');
                        console.log('API config modal hidden');
                    } else {
                        console.error('API config modal element not found');
                    }
                } catch (error) {
                    console.error('Error hiding API config modal:', error);
                    // 直接通过DOM查询找到元素
                    try {
                        const modal = document.getElementById('apiConfigModal');
                        if (modal) {
                            modal.classList.add('hidden');
                            console.log('API config modal hidden through direct DOM query');
                        }
                    } catch (e) {
                        console.error('Error in fallback hide:', e);
                    }
                }
            }
            
            function showNewApiConfigModal() {
                console.log('Showing new API config modal');
                try {
                    elements.newApiConfigName.value = '';
                    elements.newApiConfigBaseUrl.value = '';
                    elements.newApiConfigApiKey.value = '';
                    elements.newModelInput.value = '';
                    state.tempModels = []; // 清空临时模型列表
                    updateTempModelsDisplay();
                    
                    if (elements.newApiConfigModal) {
                        elements.newApiConfigModal.classList.remove('hidden');
                        console.log('New API config modal displayed');
                    } else {
                        console.error('New API config modal element not found');
                    }
                } catch (error) {
                    console.error('Error showing new API config modal:', error);
                }
            }
            
            function hideNewApiConfigModal() {
                console.log('Hiding new API config modal');
                try {
                    if (elements.newApiConfigModal) {
                        elements.newApiConfigModal.classList.add('hidden');
                        console.log('New API config modal hidden');
                    } else {
                        console.error('New API config modal element not found');
                    }
                } catch (error) {
                    console.error('Error hiding new API config modal:', error);
                }
            }
            
            function addModelToTempList() {
                console.log('Adding model to temp list');
                try {
                    // 直接从DOM获取元素
                    const newModelInput = document.getElementById('newModelInput');
                    const modelName = newModelInput ? newModelInput.value.trim() : '';
                    
                    if (!modelName) {
                        showToast('模型名称不能为空', 'error');
                        return;
                    }
                    
                    // 检查是否已存在该模型
                    if (state.tempModels.includes(modelName)) {
                        showToast('已添加该模型', 'error');
                        return;
                    }
                    
                    // 添加到临时列表
                    state.tempModels.push(modelName);
                    
                    // 更新显示
                    updateTempModelsDisplay();
                    
                    // 清空输入框
                    if (newModelInput) {
                        newModelInput.value = '';
                    }
                    
                    console.log('Model added to temp list:', modelName);
                } catch (error) {
                    console.error('Error adding model to temp list:', error);
                }
            }
            
            function updateTempModelsDisplay() {
                console.log('Updating temp models display');
                try {
                    // 直接从DOM获取元素
                    const modelsContainer = document.getElementById('newApiConfigModelsContainer');
                    if (!modelsContainer) {
                        console.error('New API config models container not found in DOM');
                        return;
                    }
                    
                    // 清空当前显示
                    modelsContainer.innerHTML = '';
                    
                    // 添加每个临时模型
                    state.tempModels.forEach(model => {
                        const modelItem = document.createElement('div');
                        modelItem.className = 'flex justify-between items-center mb-1 p-1 border-b border-gray-200 dark:border-gray-700';
                        
                        const modelName = document.createElement('span');
                        modelName.textContent = model;
                        modelName.className = 'text-sm text-gray-700 dark:text-gray-300';
                        
                        const removeBtn = document.createElement('button');
                        removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                        removeBtn.className = 'text-red-500 hover:text-red-700';
                        removeBtn.addEventListener('click', () => {
                            // 从临时列表中移除
                            state.tempModels = state.tempModels.filter(m => m !== model);
                            updateTempModelsDisplay();
                        });
                        
                        modelItem.appendChild(modelName);
                        modelItem.appendChild(removeBtn);
                        
                        modelsContainer.appendChild(modelItem);
                    });
                    
                    // 如果没有模型，显示提示
                    if (state.tempModels.length === 0) {
                        const emptyMsg = document.createElement('div');
                        emptyMsg.textContent = '请添加至少一个模型';
                        emptyMsg.className = 'text-sm text-gray-500 dark:text-gray-400 text-center p-2';
                        modelsContainer.appendChild(emptyMsg);
                    }
                    
                    console.log('Temp models display updated');
                } catch (error) {
                    console.error('Error updating temp models display:', error);
                }
            }
            
            function addNewApiConfig() {
                console.log('Adding new API config');
                try {
                    // 直接从DOM获取元素
                    const nameInput = document.getElementById('newApiConfigName');
                    const baseURLInput = document.getElementById('newApiConfigBaseUrl');
                    const apiKeyInput = document.getElementById('newApiConfigApiKey');
                    
                    if (!nameInput || !baseURLInput || !apiKeyInput) {
                        console.error('Required form elements not found');
                        showToast('表单元素未找到', 'error');
                        return;
                    }
                    
                    const name = nameInput.value.trim();
                    const baseURL = baseURLInput.value.trim();
                    const apiKey = apiKeyInput.value.trim();
                    
                    if (!name) {
                        showToast('配置名称不能为空', 'error');
                        return;
                    }
                    
                    if (!baseURL) {
                        showToast('Base URL不能为空', 'error');
                        return;
                    }
                    
                    if (!apiKey) {
                        showToast('API Key不能为空', 'error');
                        return;
                    }
                    
                    if (state.tempModels.length === 0) {
                        showToast('请至少添加一个模型', 'error');
                        return;
                    }
                    
                    // Check if config name already exists
                    if (state.apiConfigs.some(config => config.name === name)) {
                        showToast('已存在相同名称的配置', 'error');
                        return;
                    }
                    
                    // Create new config
                    const newConfig = {
                        id: generateId(),
                        name,
                        baseURL,
                        apiKey,
                        models: [...state.tempModels]
                    };
                    
                    console.log('New config created:', newConfig.name);
                    
                    // Add to state
                    state.apiConfigs.push(newConfig);
                    
                    // Update UI
                    updateApiConfigsDisplay();
                    updateModelSelects();
                    
                    // Save state
                    saveState();
                    
                    // Hide modal
                    const newApiConfigModal = document.getElementById('newApiConfigModal');
                    if (newApiConfigModal) {
                        newApiConfigModal.classList.add('hidden');
                    }
                    
                    // Show toast
                    showToast(`API配置 "${name}" 已添加`);
                    
                    console.log('New API config added successfully');
                } catch (error) {
                    console.error('Error adding new API config:', error);
                    showToast('添加配置时出错', 'error');
                }
            }
            
            function showDeleteApiConfigConfirm(configId) {
                // Find the config
                const config = state.apiConfigs.find(c => c.id === configId);
                if (!config) {
                    showToast('API配置未找到', 'error');
                    return;
                }
                
                // Set up confirm delete modal
                state.deleteType = 'apiConfig';
                state.deleteTarget = configId;
                const confirmDeleteMessage = document.getElementById('confirmDeleteMessage');
                if (confirmDeleteMessage) {
                    confirmDeleteMessage.textContent = `确定要删除API配置 "${config.name}" 吗？`;
                }
                
                // Show modal
                const confirmDeleteModal = document.getElementById('confirmDeleteModal');
                if (confirmDeleteModal) {
                    confirmDeleteModal.style.display = 'flex';
                }
            }
            
            function deleteApiConfig() {
                const configId = state.deleteTarget;
                const configIndex = state.apiConfigs.findIndex(c => c.id === configId);
                
                if (configIndex === -1) {
                    showToast('API配置未找到', 'error');
                    return;
                }
                
                // Get config name for the toast
                const configName = state.apiConfigs[configIndex].name;
                
                // Remove config
                state.apiConfigs.splice(configIndex, 1);
                
                // Update UI
                updateApiConfigsDisplay();
                updateModelSelects();
                
                // Save state
                saveState();
                
                // Show toast
                showToast(`API配置 "${configName}" 已删除`);
            }

            function updateApiConfigsDisplay() {
                console.log('Updating API configs display');
                try {
                    // Clear current API configs
                    if (elements.apiConfigsContainer) {
                        elements.apiConfigsContainer.innerHTML = '';
                        
                        // Add each API config
                        state.apiConfigs.forEach(config => {
                            const configCard = document.createElement('div');
                            configCard.className = 'border border-gray-200 dark:border-gray-700 rounded p-4 relative';
                            
                            const nameElement = document.createElement('h5');
                            nameElement.className = 'font-medium text-gray-800 dark:text-gray-200 mb-2';
                            nameElement.textContent = config.name;
                            
                            const baseUrlElement = document.createElement('div');
                            baseUrlElement.className = 'text-sm text-gray-600 dark:text-gray-400 mb-1';
                            baseUrlElement.textContent = `Base URL: ${config.baseURL}`;
                            
                            const apiKeyElement = document.createElement('div');
                            apiKeyElement.className = 'text-sm text-gray-600 dark:text-gray-400 mb-1';
                            apiKeyElement.textContent = `API Key: ${'•'.repeat(10)}`;
                            
                            const modelsElement = document.createElement('div');
                            modelsElement.className = 'text-sm text-gray-600 dark:text-gray-400 mb-2';
                            modelsElement.textContent = `模型: ${config.models.join(', ')}`;
                            
                            // 按钮容器
                            const btnContainer = document.createElement('div');
                            btnContainer.className = 'flex space-x-2';
                            
                            // 创建编辑按钮
                            const editBtn = document.createElement('button');
                            editBtn.className = 'btn-secondary text-sm mt-2';
                            editBtn.textContent = '编辑';
                            editBtn.addEventListener('click', () => {
                                showEditApiConfigModal(config.id);
                            });
                            
                            // 创建删除按钮
                            const deleteBtn = document.createElement('button');
                            deleteBtn.className = 'btn-danger text-sm mt-2';
                            deleteBtn.textContent = '删除';
                            deleteBtn.addEventListener('click', () => {
                                showDeleteApiConfigConfirm(config.id);
                            });
                            
                            // 添加按钮到按钮容器
                            btnContainer.appendChild(editBtn);
                            btnContainer.appendChild(deleteBtn);
                            
                            configCard.appendChild(nameElement);
                            configCard.appendChild(baseUrlElement);
                            configCard.appendChild(apiKeyElement);
                            configCard.appendChild(modelsElement);
                            configCard.appendChild(btnContainer);
                            
                            elements.apiConfigsContainer.appendChild(configCard);
                        });
                        
                        console.log('API configs display updated');
                    } else {
                        console.error('API configs container element not found');
                    }
                } catch (error) {
                    console.error('Error updating API configs display:', error);
                }
            }

            // 确保新类别按钮在所有情况下都可以正常工作
            const newCategoryBtn = document.getElementById('newCategoryBtn');
            if (newCategoryBtn) {
                newCategoryBtn.addEventListener('click', function() {
                    console.log('New Category button clicked');
                    const modal = document.getElementById('newCategoryModal');
                    if (modal) {
                        // 清空输入框
                        const nameInput = document.getElementById('newCategoryName');
                        if (nameInput) {
                            nameInput.value = '';
                        }
                        modal.classList.remove('hidden');
                    } else {
                        console.error('New Category modal not found');
                    }
                });
            }

            const cancelNewCategoryBtn = document.getElementById('cancelNewCategoryBtn');
            if (cancelNewCategoryBtn) {
                cancelNewCategoryBtn.addEventListener('click', function() {
                    console.log('Cancel New Category button clicked');
                    const modal = document.getElementById('newCategoryModal');
                    if (modal) {
                        modal.classList.add('hidden');
                    }
                });
            }

            const saveNewCategoryBtn = document.getElementById('saveNewCategoryBtn');
            if (saveNewCategoryBtn) {
                saveNewCategoryBtn.addEventListener('click', function() {
                    console.log('Save New Category button clicked');
                    const nameInput = document.getElementById('newCategoryName');
                    if (!nameInput) {
                        console.error('Category name input not found');
                        return;
                    }

                    const categoryName = nameInput.value.trim();
                    
                    if (!categoryName) {
                        showToast('Category name cannot be empty', 'error');
                        return;
                    }
                    
                    // Check if category already exists
                    if (state.categories.some(c => c.name === categoryName)) {
                        showToast('A category with this name already exists', 'error');
                        return;
                    }
                    
                    // Create new category
                    const newCategory = {
                        id: generateId(),
                        name: categoryName
                    };
                    
                    // Add to state
                    state.categories.push(newCategory);
                    state.currentCategory = newCategory.id;
                    state.currentPrompt = null;
                    
                    // Initialize prompts for this category
                    state.prompts[newCategory.id] = [];
                    
                    // Update UI
                    updateCategorySelect();
                    updatePromptSelect();
                    clearPromptEditor();
                    
                    // Save state
                    saveState();
                    
                    // Hide modal
                    const modal = document.getElementById('newCategoryModal');
                    if (modal) {
                        modal.classList.add('hidden');
                    }
                    
                    // Show toast
                    showToast(`Category "${categoryName}" created`);
                });
            }

            // 修复API配置弹窗的按钮
            // 关闭API配置弹窗按钮
            const closeApiConfigBtn = document.getElementById('closeApiConfigBtn');
            if (closeApiConfigBtn) {
                closeApiConfigBtn.addEventListener('click', function() {
                    console.log('Close API Config button clicked');
                    const modal = document.getElementById('apiConfigModal');
                    if (modal) {
                        modal.classList.add('hidden');
                    }
                });
            }

            // 添加新API配置按钮
            const addApiConfigBtn = document.getElementById('addApiConfigBtn');
            if (addApiConfigBtn) {
                addApiConfigBtn.addEventListener('click', function() {
                    console.log('Add API Config button clicked');
                    const newApiConfigModal = document.getElementById('newApiConfigModal');
                    if (newApiConfigModal) {
                        // 清空表单
                        const nameInput = document.getElementById('newApiConfigName');
                        const baseUrlInput = document.getElementById('newApiConfigBaseUrl');
                        const apiKeyInput = document.getElementById('newApiConfigApiKey');
                        const modelInputContainer = document.querySelector('#newApiConfigModal .flex.items-center.space-x-2');
                        
                        if (nameInput) nameInput.value = '';
                        if (baseUrlInput) baseUrlInput.value = '';
                        if (apiKeyInput) apiKeyInput.value = '';
                        
                        // 更新模型输入区域，添加刷新按钮
                        if (modelInputContainer) {
                            modelInputContainer.outerHTML = newApiConfigModelInputHTML;
                            
                            // 重新绑定事件
                            const addModelToConfigBtn = document.getElementById('addModelToConfigBtn');
                            if (addModelToConfigBtn) {
                                addModelToConfigBtn.addEventListener('click', addModelToTempList);
                            }
                            
                            const refreshNewModelsBtn = document.getElementById('refreshNewModelsBtn');
                            if (refreshNewModelsBtn) {
                                refreshNewModelsBtn.addEventListener('click', fetchModelsForNew);
                            }
                        }
                        
                        // 清空临时模型列表
                        state.tempModels = [];
                        updateTempModelsDisplay();
                        
                        // 显示弹窗
                        newApiConfigModal.classList.remove('hidden');
                    } else {
                        console.error('New API Config modal not found');
                    }
                });
            }

            // 在newApiConfigModal和editApiConfigModal的模型输入区添加刷新按钮
            const newApiConfigModelInputHTML = `
            <div class="flex items-center space-x-2">
                <input id="newModelInput" type="text" class="flex-grow p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200" placeholder="输入模型名称，如 gpt-3.5-turbo">
                <button id="addModelToConfigBtn" class="btn-outline">添加</button>
                <button id="refreshNewModelsBtn" class="btn-outline p-2 ml-1" title="自动获取模型列表">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            `;

            // 在DOMContentLoaded结束前添加代码
            // 添加获取模型列表功能
            function fetchModelsForNew() {
                const baseUrlInput = document.getElementById('newApiConfigBaseUrl');
                const apiKeyInput = document.getElementById('newApiConfigApiKey');

                if (!baseUrlInput || !apiKeyInput) {
                    showToast('找不到必要的输入字段', 'error');
                    return;
                }

                const baseURL = baseUrlInput.value.trim();
                const apiKey = apiKeyInput.value.trim();

                if (!baseURL || !apiKey) {
                    showToast('请先填写Base URL和API Key', 'error');
                    return;
                }

                fetchModelsList(baseURL, apiKey, (models) => {
                    // 清空并添加新的模型
                    state.tempModels = models;
                    updateTempModelsDisplay();
                    showToast('成功获取模型列表', 'success');
                });
            }

            function fetchModelsForEdit() {
                const baseUrlInput = document.getElementById('editApiConfigBaseUrl');
                const apiKeyInput = document.getElementById('editApiConfigApiKey');

                if (!baseUrlInput || !apiKeyInput) {
                    showToast('找不到必要的输入字段', 'error');
                    return;
                }

                const baseURL = baseUrlInput.value.trim();
                const apiKey = apiKeyInput.value.trim();

                if (!baseURL || !apiKey) {
                    showToast('请先填写Base URL和API Key', 'error');
                    return;
                }

                fetchModelsList(baseURL, apiKey, (models) => {
                    // 清空并添加新的模型
                    state.editTempModels = models;
                    updateEditTempModelsDisplay();
                    showToast('成功获取模型列表', 'success');
                });
            }

            // 通用函数，获取模型列表
            async function fetchModelsList(baseURL, apiKey, callback) {
                try {
                    // 显示加载状态
                    showToast('正在获取模型列表...', 'info');
                    
                    const endpoint = `${baseURL}/models`;
                    
                    const response = await fetch(endpoint, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`
                        }
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error?.message || `获取模型列表失败: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (!data.data || !Array.isArray(data.data)) {
                        throw new Error('获取到的模型数据格式不正确');
                    }
                    
                    // 提取模型ID
                    const models = data.data
                        .filter(model => model.id && typeof model.id === 'string')
                        .map(model => model.id)
                        // 过滤掉一些非文本生成模型
                        .filter(id => !id.includes('embedding') && !id.includes('search'));
                    
                    if (callback && typeof callback === 'function') {
                        callback(models);
                    }
                    
                    return models;
                } catch (error) {
                    console.error('获取模型列表失败:', error);
                    showToast(`获取模型列表失败: ${error.message}`, 'error');
                    return [];
                }
            }

            // 显示编辑API配置模态框
            function showEditApiConfigModal(configId) {
                console.log('Showing edit API config modal for ID:', configId);
                // 找到配置
                const config = state.apiConfigs.find(c => c.id === configId);
                if (!config) {
                    showToast('API配置未找到', 'error');
                    return;
                }
                
                // 获取DOM元素
                const modal = document.getElementById('editApiConfigModal');
                const nameInput = document.getElementById('editApiConfigName');
                const baseUrlInput = document.getElementById('editApiConfigBaseUrl');
                const apiKeyInput = document.getElementById('editApiConfigApiKey');
                const idInput = document.getElementById('editApiConfigId');
                
                if (!modal || !nameInput || !baseUrlInput || !apiKeyInput || !idInput) {
                    console.error('编辑模态框元素未找到', {modal, nameInput, baseUrlInput, apiKeyInput, idInput});
                    showToast('页面元素未找到', 'error');
                    return;
                }
                
                // 填充当前值
                nameInput.value = config.name || '';
                baseUrlInput.value = config.baseURL || '';
                apiKeyInput.value = config.apiKey || '';
                idInput.value = config.id || '';
                
                // 清空并填充模型列表
                state.editTempModels = [...(config.models || [])];
                updateEditTempModelsDisplay();
                
                // 显示模态框
                modal.classList.remove('hidden');
                
                // 设置按钮事件
                const addModelToEditBtn = document.getElementById('addModelToEditBtn');
                const cancelEditApiConfigBtn = document.getElementById('cancelEditApiConfigBtn');
                const saveEditApiConfigBtn = document.getElementById('saveEditApiConfigBtn');
                const refreshModelsBtn = document.getElementById('refreshModelsBtn');
                
                // 添加模型按钮
                if (addModelToEditBtn) {
                    // 先移除之前的事件监听器
                    const newAddModelToEditBtn = addModelToEditBtn.cloneNode(true);
                    addModelToEditBtn.parentNode.replaceChild(newAddModelToEditBtn, addModelToEditBtn);
                    newAddModelToEditBtn.addEventListener('click', addModelToEditList);
                }
                
                // 取消按钮
                if (cancelEditApiConfigBtn) {
                    const newCancelEditApiConfigBtn = cancelEditApiConfigBtn.cloneNode(true);
                    cancelEditApiConfigBtn.parentNode.replaceChild(newCancelEditApiConfigBtn, cancelEditApiConfigBtn);
                    newCancelEditApiConfigBtn.addEventListener('click', hideEditApiConfigModal);
                }
                
                // 保存按钮
                if (saveEditApiConfigBtn) {
                    const newSaveEditApiConfigBtn = saveEditApiConfigBtn.cloneNode(true);
                    saveEditApiConfigBtn.parentNode.replaceChild(newSaveEditApiConfigBtn, saveEditApiConfigBtn);
                    newSaveEditApiConfigBtn.addEventListener('click', saveEditApiConfig);
                }
                
                // 刷新模型按钮
                if (refreshModelsBtn) {
                    const newRefreshModelsBtn = refreshModelsBtn.cloneNode(true);
                    refreshModelsBtn.parentNode.replaceChild(newRefreshModelsBtn, refreshModelsBtn);
                    newRefreshModelsBtn.addEventListener('click', fetchModelsForEdit);
                }
            }

            // 隐藏编辑API配置模态框
            function hideEditApiConfigModal() {
                const modal = document.getElementById('editApiConfigModal');
                if (modal) {
                    modal.classList.add('hidden');
                }
            }

            // 更新编辑中的临时模型显示
            function updateEditTempModelsDisplay() {
                const modelsContainer = document.getElementById('editApiConfigModelsContainer');
                if (!modelsContainer) {
                    console.error('编辑API配置模型容器未找到');
                    return;
                }
                
                // 清空当前显示
                modelsContainer.innerHTML = '';
                
                // 添加每个临时模型
                state.editTempModels.forEach(model => {
                    const modelItem = document.createElement('div');
                    modelItem.className = 'flex justify-between items-center mb-1 p-1 border-b border-gray-200 dark:border-gray-700';
                    
                    const modelName = document.createElement('span');
                    modelName.textContent = model;
                    modelName.className = 'text-sm text-gray-700 dark:text-gray-300';
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                    removeBtn.className = 'text-red-500 hover:text-red-700';
                    removeBtn.addEventListener('click', () => {
                        // 从临时列表中移除
                        state.editTempModels = state.editTempModels.filter(m => m !== model);
                        updateEditTempModelsDisplay();
                    });
                    
                    modelItem.appendChild(modelName);
                    modelItem.appendChild(removeBtn);
                    
                    modelsContainer.appendChild(modelItem);
                });
                
                // 如果没有模型，显示提示
                if (state.editTempModels.length === 0) {
                    const emptyMsg = document.createElement('div');
                    emptyMsg.textContent = '请添加至少一个模型';
                    emptyMsg.className = 'text-sm text-gray-500 dark:text-gray-400 text-center p-2';
                    modelsContainer.appendChild(emptyMsg);
                }
            }

            // 添加模型到编辑列表
            function addModelToEditList() {
                const modelInput = document.getElementById('editModelInput');
                if (!modelInput) {
                    console.error('编辑模型输入框未找到');
                    return;
                }
                
                const modelName = modelInput.value.trim();
                if (!modelName) {
                    showToast('模型名称不能为空', 'error');
                    return;
                }
                
                // 检查是否已存在该模型
                if (state.editTempModels.includes(modelName)) {
                    showToast('已添加该模型', 'error');
                    return;
                }
                
                // 添加到临时列表
                state.editTempModels.push(modelName);
                
                // 更新显示
                updateEditTempModelsDisplay();
                
                // 清空输入框
                modelInput.value = '';
            }

            // 保存编辑后的API配置
            function saveEditApiConfig() {
                const nameInput = document.getElementById('editApiConfigName');
                const baseUrlInput = document.getElementById('editApiConfigBaseUrl');
                const apiKeyInput = document.getElementById('editApiConfigApiKey');
                const idInput = document.getElementById('editApiConfigId');
                
                if (!nameInput || !baseUrlInput || !apiKeyInput || !idInput) {
                    console.error('必要的编辑表单元素未找到');
                    showToast('表单元素未找到', 'error');
                    return;
                }
                
                const configId = idInput.value.trim();
                const name = nameInput.value.trim();
                const baseURL = baseUrlInput.value.trim();
                const apiKey = apiKeyInput.value.trim();
                
                if (!name) {
                    showToast('配置名称不能为空', 'error');
                    return;
                }
                
                if (!baseURL) {
                    showToast('Base URL不能为空', 'error');
                    return;
                }
                
                if (!apiKey) {
                    showToast('API Key不能为空', 'error');
                    return;
                }
                
                if (state.editTempModels.length === 0) {
                    showToast('请至少添加一个模型', 'error');
                    return;
                }
                
                // 检查配置名称是否已存在(排除当前编辑的配置)
                if (state.apiConfigs.some(config => config.name === name && config.id !== configId)) {
                    showToast('已存在相同名称的配置', 'error');
                    return;
                }
                
                // 找到配置并更新
                const configIndex = state.apiConfigs.findIndex(c => c.id === configId);
                if (configIndex === -1) {
                    showToast('未找到要编辑的API配置', 'error');
                    return;
                }
                
                // 更新配置
                state.apiConfigs[configIndex] = {
                    ...state.apiConfigs[configIndex],
                    name,
                    baseURL,
                    apiKey,
                    models: [...state.editTempModels]
                };
                
                // 更新UI
                updateApiConfigsDisplay();
                updateModelSelects();
                
                // 保存状态
                saveState();
                
                // 隐藏模态框
                hideEditApiConfigModal();
                
                // 显示提示
                showToast(`API配置 "${name}" 已更新`);
            }

            function bindConfirmDeleteButtons() {
                // 确认删除按钮
                const confirmDeleteButton = document.getElementById('confirmDeleteButton');
                if (confirmDeleteButton) {
                    confirmDeleteButton.addEventListener('click', () => {
                        if (state.deleteType === 'category') {
                            deleteCategory();
                        } else if (state.deleteType === 'prompt') {
                            deletePrompt();
                        } else if (state.deleteType === 'stableVersion') {
                            deleteStableVersion();
                        } else if (state.deleteType === 'apiConfig') {
                            deleteApiConfig();
                        }
                        hideConfirmDeleteModal();
                    });
                }

                // 取消删除按钮
                const cancelDeleteButton = document.getElementById('cancelDeleteButton');
                if (cancelDeleteButton) {
                    cancelDeleteButton.addEventListener('click', hideConfirmDeleteModal);
                }
                
                // 点击模态框背景关闭
                const confirmDeleteModal = document.getElementById('confirmDeleteModal');
                if (confirmDeleteModal) {
                    confirmDeleteModal.addEventListener('click', (e) => {
                        if (e.target === confirmDeleteModal) {
                            hideConfirmDeleteModal();
                        }
                    });
                }
            }

            function bindEditApiConfigButtons() {
                const editButtons = document.querySelectorAll('.edit-api-config-button');
                editButtons.forEach(button => {
                    const configId = button.getAttribute('data-id');
                    button.addEventListener('click', () => {
                        showEditApiConfigModal(configId);
                    });
                });
            }
        });
    </script>

    <!-- Vercel Insights Script -->
    <script>      window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/insights/script.js"></script>

    <!-- Vercel Speed Insights Script -->
    <script>      window.si = window.si || function () { (window.siq = window.siq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/speed-insights/script.js"></script>

</body>
</html>
